<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OSP Central</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&family=Lora:ital,wght@0,500;0,600;1,400&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body,#root{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:#f5f0eb;color:#2d2a26}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:#d4c9bb;border-radius:4px}
input,textarea,select,button{font-family:inherit}
button{cursor:pointer}
a{text-decoration:none;cursor:pointer}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fade{animation:fadeUp .18s ease}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{display:inline-block;animation:spin 1s linear infinite}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useMemo,useRef} = React;

/* ‚îÄ‚îÄ TOKENS ‚îÄ‚îÄ */
const C = {
  bg:"#f5f0eb", sb:"#ede8e0", card:"#fff", border:"#e2d9cf",
  text:"#2d2a26", t2:"#6b6358", t3:"#a89f92",
  accent:"#5b5bd6", cream:"#faf7f4",
  red:"#ef4444", orange:"#f97316", green:"#10b981",
  yellow:"#f59e0b", purple:"#8b5cf6", blue:"#3b82f6",
};

/* ‚îÄ‚îÄ STATIC DATA ‚îÄ‚îÄ */
const TEAM = ["Salma","JE","ZM","Alena","Sajjad","Cleo","Jen","Zach","Rachel","Eric","Japeck","Rebecca","Lauren","Kirby","Stacey","OPE Leads"];
const WORKSTREAMS = ["OPE Digest","OPE Leads In-Person Event","OPE Leads Weekly Meeting","Onboarding ‚Äî Allie","Assessment History / Report","OSP Operations","OSP Team Meeting Prep","UX & Design ‚Äî Insight","Insight Projects","RESC Monthly Meeting","Race & Equity Session (March)","Supervisor 1:1","PM Engagement Check-In","Hiring / Resume Review","Performance Reviews","Other"];
const SECTIONS = [
  {id:"all",       label:"All",                icon:"‚óà", color:C.accent},
  {id:"supervisor",label:"Supervisor Check-In", icon:"‚óà", color:C.blue,   tag:"Supervisor"},
  {id:"osp",       label:"OSP Operations",      icon:"‚óÜ", color:C.green,  tag:"OSP Ops"},
  {id:"insight",   label:"PM ¬∑ Insight",         icon:"‚óâ", color:C.purple, tag:"Insight"},
  {id:"events",    label:"Events & Engagement",  icon:"‚óá", color:C.yellow, tag:"Events"},
  {id:"meetings",  label:"Meetings",             icon:"‚ó∑", color:C.red,    tag:"Meeting"},
];
const PRIS = [
  {id:"urgent",label:"Urgent",color:C.red},
  {id:"high",  label:"High",  color:C.orange},
  {id:"normal",label:"Normal",color:C.accent},
  {id:"low",   label:"Low",   color:"#94a3b8"},
];
const STATS = [
  {id:"pending",   label:"Pending",    dot:C.orange},
  {id:"inprogress",label:"In Progress",dot:C.blue},
  {id:"blocked",   label:"Blocked",    dot:C.red},
  {id:"done",      label:"Done",       dot:C.green},
  {id:"archived",  label:"Archived",   dot:"#94a3b8"},
];
const VIEWS = [
  {id:"dashboard", label:"Dashboard",   icon:"üìä"},
  {id:"prep",      label:"Meeting Prep",icon:"üéØ"},
  {id:"notes",     label:"Notes",       icon:"üìù"},
  {id:"cards",     label:"Cards",       icon:"‚ñ¶"},
  {id:"search",    label:"Search",      icon:"üîç"},
  {id:"history",   label:"History",     icon:"üìö"},
  {id:"archive",   label:"Archive",     icon:"üóÇ"},
  {id:"todo",      label:"To-Do",       icon:"‚úÖ"},
  {id:"gantt",     label:"Gantt",       icon:"üìÖ"},
  {id:"calendar",  label:"Calendar",    icon:"üóì"},
  {id:"monitor",   label:"Monitor",     icon:"üîó"},
];
const TFIELDS = [
  {key:"agenda",    label:"Agenda / Topics",        icon:"üìã", ph:"What was covered..."},
  {key:"decisions", label:"Key Decisions",           icon:"‚úÖ", ph:"Decisions reached..."},
  {key:"actions",   label:"Action Items (who + due)",icon:"‚ö°", ph:"Salma ‚Äî follow up with X by date..."},
  {key:"nextsteps", label:"Next Steps",              icon:"‚Üí",  ph:"What happens next..."},
  {key:"blockers",  label:"Blockers / Dependencies", icon:"‚ö†",  ph:"What's in the way..."},
  {key:"notes",     label:"My Notes / Thoughts",     icon:"üí≠", ph:"Anything else..."},
];
const TMPLS = {
  supervisor:{id:"supervisor",label:"Supervisor 1:1 (Weekly)",section:"supervisor",title:"Supervisor 1:1",attendees:"",agenda:"1. Weekly priorities review\n2. Staffing updates (Allie onboarding, open roles)\n3. Performance review status\n4. OSP blockers / escalations\n5. Budget / resource needs"},
  insight:   {id:"insight",   label:"PM Engagement Check-In", section:"insight",   title:"PM Engagement Check-In",attendees:"JE, ZM, Rachel",agenda:"1. Sprint status & Jira board review (TDPGM / SQRT / SQR)\n2. Assessment History / Report progress\n3. UX & Design updates\n4. Open questions / blockers"},
  osp:       {id:"osp",       label:"OSP Team Meeting (Bi-weekly Friday)", section:"osp",  title:"OSP Team Meeting",attendees:"Alena, Sajjad, Cleo, Jen, Zach, Rebecca, Lauren, Kirby, Stacey",agenda:"1. Team updates & announcements\n2. Onboarding ‚Äî Allie status\n3. Helpdesk queue (Zendesk)\n4. Operations updates\n5. Wins & shoutouts"},
  events:    {id:"events",    label:"OPE Leads (Every Monday)",            section:"events",title:"OPE Leads Weekly Meeting",attendees:"OPE Leads, Japeck, Salma",agenda:"1. Priorities for the week\n2. OPE Digest status & content\n3. In-person event planning\n4. RESC / Race & Equity updates\n5. Comms & engagement calendar"},
  meetings:  {id:"meetings",  label:"Insight Full Team (Bi-weekly)",       section:"meetings",title:"Insight Full Team Meeting",attendees:"Japeck, Rachel, Alena, Rebecca, Salma, Eric",agenda:"1. Product updates & demos\n2. Jira board walkthrough\n3. QC / release readiness\n4. Upcoming milestones\n5. Open questions"},
};
const ALL_TMPLS = Object.values(TMPLS);

const DOE_HOLIDAYS = [
  {date:"2026-03-30",label:"Spring Recess",type:"break"},
  {date:"2026-03-31",label:"Spring Recess",type:"break"},
  {date:"2026-04-01",label:"Spring Recess",type:"break"},
  {date:"2026-04-02",label:"Spring Recess",type:"break"},
  {date:"2026-04-03",label:"Spring Recess",type:"break"},
  {date:"2026-05-25",label:"Memorial Day",type:"holiday"},
  {date:"2026-06-19",label:"Juneteenth",type:"holiday"},
  {date:"2026-07-04",label:"Independence Day",type:"holiday"},
];

const DEF_SETTINGS = {
  jiraBoards:[
    {id:1,name:"TDPGM",base:"https://doeord.atlassian.net/browse",prefix:"TDPGM"},
    {id:2,name:"SQRT", base:"https://doeord.atlassian.net/browse",prefix:"SQRT"},
    {id:3,name:"SQR",  base:"https://doeord.atlassian.net/browse",prefix:"SQR"},
  ],
  zendeskBoards:[{id:1,name:"OSP Helpdesk",base:"https://doeord.zendesk.com"}],
  slackChannels:[{id:1,name:"#osp-team",workspace:"",channel:"osp-team"},{id:2,name:"#ope-leads",workspace:"",channel:"ope-leads"}],
  teamsChannels:[{id:1,name:"OSP General",url:"https://teams.microsoft.com"},{id:2,name:"Insight Team",url:"https://teams.microsoft.com"}],
  importantDates:[
    {id:1,date:"2026-03-02",label:"Allie starts",type:"custom"},
    {id:2,date:"2026-02-28",label:"Performance Review due",type:"deadline"},
  ],
  showDOE:true,
};

const SAMPLE = [
  {id:1,section:"insight",title:"Assessment History ‚Äî Summary section",workstream:"Assessment History / Report",agenda:"Summary section walkthrough with data team",decisions:"Show overall HS student status",actions:"Salma ‚Äî TDPGM-9217 by 2/26",nextsteps:"Dev to start layout",blockers:"",notes:"Details dropdown + State tests TBD",priority:"urgent",status:"pending",owner:"Salma",jira:"TDPGM-9217",startDate:"2026-02-26",due:"2026-03-05",carryOver:true,date:"2026-02-26",type:"checkin",linkedItems:[]},
  {id:2,section:"osp",title:"Onboarding ‚Äî Allie (starts 3/2)",workstream:"Onboarding ‚Äî Allie",agenda:"Review onboarding checklist",decisions:"Salma to own access coordination",actions:"Salma ‚Äî follow up with Sajjad on seating by 2/28",nextsteps:"Create onboarding calendar invite",blockers:"Waiting on IT for computer",notes:"Formerly Rachel He's computer",priority:"high",status:"pending",owner:"Salma",jira:"",startDate:"2026-02-23",due:"2026-03-02",carryOver:true,date:"2026-02-23",type:"checkin",linkedItems:[]},
  {id:3,section:"supervisor",title:"OSP Performance Review",workstream:"Performance Reviews",agenda:"360 review process + timeline",decisions:"Complete by end of Feb",actions:"Salma ‚Äî follow up on 360 framework by 2/25",nextsteps:"Complete self-evaluation",blockers:"Waiting on OPS for framework",notes:"",priority:"high",status:"pending",owner:"Salma",jira:"",startDate:"2026-01-26",due:"2026-02-28",carryOver:true,date:"2026-01-26",type:"checkin",linkedItems:[]},
  {id:4,section:"meetings",title:"Insight Leads Meeting 2/26",workstream:"Insight Projects",agenda:"Assessment Report walkthrough, NYSESLAT data, Alerts rollup",decisions:"Remove 'new framework' from US History test name",actions:"Rachel ‚Äî Jira for dev re: Assessment layout\nAlena ‚Äî confirm Alerts rules",nextsteps:"QC begins week of 2.2",blockers:"Rebecca OoO 2/19",notes:"Multiple years of assessment data needed",priority:"normal",status:"done",owner:"Salma",jira:"TDPGM-9217",startDate:"2026-02-26",due:"2026-02-26",carryOver:false,date:"2026-02-26",type:"meeting",attendees:"Japeck, Rachel, Alena, Rebecca, Salma",linkedItems:[1]},
  {id:5,section:"events",title:"OPE Digest ‚Äî language + photos",workstream:"OPE Digest",agenda:"Draft copy review",decisions:"Use Q1 cohort photos from Feb session",actions:"Salma ‚Äî draft language by 3/5\nZM ‚Äî review and approve",nextsteps:"Send to design by 3/8",blockers:"",notes:"",priority:"normal",status:"inprogress",owner:"Salma",jira:"",startDate:"2026-02-19",due:"2026-03-12",carryOver:true,date:"2026-02-19",type:"checkin",linkedItems:[]},
  {id:6,section:"events",title:"Race & Equity Session ‚Äî March",workstream:"Race & Equity Session (March)",agenda:"Session planning and content",decisions:"",actions:"Salma ‚Äî confirm date with Kirby by 3/1",nextsteps:"Finalize agenda and materials",blockers:"Waiting on facilitator",notes:"",priority:"high",status:"pending",owner:"Salma",jira:"",startDate:"2026-02-24",due:"2026-03-15",carryOver:true,date:"2026-02-24",type:"checkin",linkedItems:[]},
];
const SAMPLE_TODOS = [
  {id:101,text:"Check OPE Leads agenda for Monday",done:false,date:today()},
  {id:102,text:"Review Zendesk helpdesk queue",done:false,date:today()},
  {id:103,text:"Follow up with Sajjad on Allie's computer",done:false,date:today()},
];

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
function today(){return new Date().toISOString().split("T")[0];}
function lastWeek(){const d=new Date();d.setDate(d.getDate()-7);return d.toISOString().split("T")[0];}
function fmt(d){if(!d)return"";return new Date(d+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"});}
function fmtFull(d){if(!d)return"";return new Date(d+"T00:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"});}
function isOD(due){return due&&new Date(due+"T00:00:00")<new Date(new Date().toDateString());}
function isSoon(due){if(!due)return false;const diff=(new Date(due+"T00:00:00")-new Date(new Date().toDateString()))/86400000;return diff>=0&&diff<=3;}
function lsGet(k,fb){try{const v=localStorage.getItem(k);return v?JSON.parse(v):fb;}catch{return fb;}}
function lsSave(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
function getPri(id){return PRIS.find(p=>p.id===id)||PRIS[2];}
function getStat(id){return STATS.find(s=>s.id===id)||STATS[0];}
function getSec(id){return SECTIONS.find(s=>s.id===id)||SECTIONS[1];}
function hl(text,q){
  if(!q||!text)return text;
  const i=text.toLowerCase().indexOf(q.toLowerCase());
  if(i===-1)return text;
  return <>{text.slice(0,i)}<mark style={{background:"#fde68a",borderRadius:2}}>{text.slice(i,i+q.length)}</mark>{text.slice(i+q.length)}</>;
}

/* ‚îÄ‚îÄ SHARED UI ‚îÄ‚îÄ */
function Tag({c,label,sm}){
  return <span style={{fontSize:sm?9:10,fontWeight:600,color:c,background:c+"18",padding:sm?"1px 6px":"2px 8px",borderRadius:20,border:`1px solid ${c}28`,whiteSpace:"nowrap"}}>{label}</span>;
}
function Chip({href,label,color}){
  return href?<a href={href} target="_blank" rel="noopener noreferrer" style={{fontSize:10,color,background:color+"15",padding:"2px 8px",borderRadius:20,border:`1px solid ${color}33`,fontWeight:600,display:"inline-flex",alignItems:"center",gap:3}}>{label} ‚Üó</a>:null;
}
function Inp({value,onChange,placeholder,type,list,mono,style:s={}}){
  return <input type={type||"text"} value={value} onChange={onChange} placeholder={placeholder} list={list}
    style={{width:"100%",background:C.cream,border:`1px solid ${C.border}`,borderRadius:8,padding:"8px 11px",color:C.text,fontSize:13,outline:"none",fontFamily:mono?"'DM Mono',monospace":"inherit",...s}}/>;
}
function Sel({value,onChange,opts}){
  return <select value={value} onChange={onChange} style={{width:"100%",background:C.cream,border:`1px solid ${C.border}`,borderRadius:8,padding:"8px 11px",color:C.text,fontSize:13,outline:"none"}}>
    {opts.map(o=><option key={o.id||o} value={o.id||o}>{o.label||o}</option>)}
  </select>;
}
function Lbl({children}){return <div style={{fontSize:10,color:C.t3,fontWeight:700,letterSpacing:"0.07em",marginBottom:4}}>{children}</div>;}
function Datalists(){return<>
  <datalist id="team">{TEAM.map(n=><option key={n} value={n}/>)}</datalist>
  <datalist id="ws">{WORKSTREAMS.map(w=><option key={w} value={w}/>)}</datalist>
</>;
}

/* ‚îÄ‚îÄ ITEM CARD ‚îÄ‚îÄ */
function ItemCard({item,settings,onEdit,onDelete,onCycle,onArchive,all,q=""}){
  const pri=getPri(item.priority),sta=getStat(item.status),sec=getSec(item.section);
  const od=isOD(item.due),soon=isSoon(item.due)&&!od;
  const jb=settings.jiraBoards?.find(b=>item.jira?.toUpperCase().startsWith(b.prefix.toUpperCase()));
  const jLink=jb?`${jb.base}/${item.jira}`:null;
  const linked=(item.linkedItems||[]).map(id=>all.find(i=>i.id===id)).filter(Boolean);
  return(
    <div className="fade" style={{background:C.card,border:`1px solid ${od?C.red+"66":soon?"#fde68a":C.border}`,borderRadius:12,padding:"14px 16px",position:"relative",borderLeft:`3px solid ${sec.color}`}}>
      <div style={{paddingRight:56,marginBottom:4}}>
        <div style={{fontSize:13,fontWeight:600,color:C.text,lineHeight:1.4,marginBottom:2}}>{q?hl(item.title,q):item.title}</div>
        {item.workstream&&<div style={{fontSize:10,color:C.t3}}>üìÅ {item.workstream}</div>}
        {item.attendees&&<div style={{fontSize:10,color:C.t3}}>üë• {item.attendees}</div>}
      </div>
      {TFIELDS.filter(f=>item[f.key]?.trim()).slice(0,3).map(f=>(
        <div key={f.key} style={{marginBottom:3}}>
          <span style={{fontSize:10,fontWeight:700,color:C.t3,textTransform:"uppercase",letterSpacing:"0.05em"}}>{f.icon} {f.label}: </span>
          <span style={{fontSize:11,color:C.t2}}>{q?hl(item[f.key].slice(0,90),q):item[f.key].slice(0,90)}{item[f.key].length>90?"‚Ä¶":""}</span>
        </div>
      ))}
      {linked.length>0&&(
        <div style={{marginTop:7,padding:"6px 9px",background:C.cream,borderRadius:7,border:`1px solid ${C.border}`}}>
          <div style={{fontSize:9,fontWeight:700,color:C.t3,letterSpacing:"0.05em",marginBottom:3}}>üîó LINKED</div>
          {linked.map(li=>(
            <div key={li.id} style={{fontSize:11,color:C.t2,display:"flex",gap:5,alignItems:"center",marginBottom:2}}>
              <span style={{color:getSec(li.section).color}}>{getSec(li.section).icon}</span>
              <span style={{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{li.title}</span>
              <Tag c={getStat(li.status).dot} label={getStat(li.status).label} sm/>
            </div>
          ))}
        </div>
      )}
      <div style={{display:"flex",flexWrap:"wrap",gap:4,marginTop:9}}>
        <Tag c={pri.color} label={pri.label.toUpperCase()} sm/>
        <span onClick={()=>onCycle&&onCycle(item)} style={{fontSize:10,fontWeight:600,color:C.t2,background:C.bg,padding:"1px 7px",borderRadius:20,border:`1px solid ${C.border}`,display:"inline-flex",alignItems:"center",gap:3,cursor:onCycle?"pointer":"default"}}>
          <span style={{width:6,height:6,borderRadius:"50%",background:sta.dot,display:"inline-block"}}/>{sta.label}
        </span>
        <Tag c={sec.color} label={sec.tag||sec.label} sm/>
        {item.startDate&&item.due&&item.startDate!==item.due&&<span style={{fontSize:9,color:C.t3,background:C.cream,padding:"1px 6px",borderRadius:20,border:`1px solid ${C.border}`}}>{fmt(item.startDate)} ‚Üí {fmt(item.due)}</span>}
        {item.due&&(!item.startDate||item.startDate===item.due)&&(
          <span style={{fontSize:9,fontWeight:600,color:od?C.red:soon?C.yellow:C.t3,background:od?"#fef2f2":soon?"#fffbeb":C.cream,padding:"1px 6px",borderRadius:20,border:`1px solid ${od?"#fca5a8":soon?"#fde68a":C.border}`}}>
            {od?"‚è∞ ":soon?"‚è± ":""}{fmt(item.due)}
          </span>
        )}
        {item.carryOver&&item.status!=="done"&&<Tag c={C.yellow} label="‚Üª Carry" sm/>}
        {item.jira&&<Chip href={jLink} label={`‚¨° ${item.jira}`} color={C.blue}/>}
      </div>
      <div style={{position:"absolute",top:10,right:8,display:"flex",gap:1}}>
        {onEdit&&<button onClick={()=>onEdit(item)} style={{background:"transparent",border:"none",color:C.t3,fontSize:13,padding:"2px 4px"}}>‚úé</button>}
        {onArchive&&item.status==="done"&&<button onClick={()=>onArchive(item.id)} title="Archive" style={{background:"transparent",border:"none",color:C.t3,fontSize:11,padding:"2px 4px"}}>üóÇ</button>}
        {onDelete&&<button onClick={()=>onDelete(item.id)} style={{background:"transparent",border:"none",color:C.t3,fontSize:11,padding:"2px 4px"}}>‚úï</button>}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
function Dashboard({items,todos,onEdit,settings,onNav}){
  const active=items.filter(i=>i.status!=="archived");
  const td=today();
  const overdue=active.filter(i=>i.status!=="done"&&isOD(i.due));
  const soon=active.filter(i=>i.status!=="done"&&isSoon(i.due)&&!isOD(i.due));
  const blocked=active.filter(i=>i.status==="blocked");
  const inprog=active.filter(i=>i.status==="inprogress");
  const todayTodos=todos.filter(t=>t.date===td);
  const doneTodos=todayTodos.filter(t=>t.done).length;
  const alertItems=[...overdue,...soon].slice(0,8);
  const bySec=SECTIONS.filter(s=>s.id!=="all").map(s=>({...s,open:active.filter(i=>i.section===s.id&&i.status!=="done").length,total:active.filter(i=>i.section===s.id).length}));
  const Stat=({label,val,color,sub,click})=>(
    <div onClick={click} style={{background:C.card,border:`1px solid ${C.border}`,borderLeft:`3px solid ${color}`,borderRadius:10,padding:"13px 15px",cursor:click?"pointer":"default"}}>
      <div style={{fontSize:22,fontWeight:700,color}}>{val}</div>
      <div style={{fontSize:12,color:C.t2,fontWeight:600,marginTop:1}}>{label}</div>
      {sub&&<div style={{fontSize:10,color:C.t3,marginTop:1}}>{sub}</div>}
    </div>
  );
  const hour=new Date().getHours();
  const greeting=hour<12?"Good morning":"hour"<17?"Good afternoon":"Good evening";
  return(
    <div style={{display:"flex",flexDirection:"column",gap:16}}>
      <div style={{fontSize:16,fontWeight:700,color:C.text,fontFamily:"'Lora',serif"}}>{greeting}, Salma üëã</div>

      {/* Stats row */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(130px,1fr))",gap:10}}>
        <Stat label="Open Items" val={active.filter(i=>i.status!=="done").length} color={C.accent} sub={`${active.filter(i=>i.status==="done").length} done`}/>
        <Stat label="In Progress" val={inprog.length} color={C.blue}/>
        <Stat label="Blocked" val={blocked.length} color={C.red} sub="needs action" click={blocked.length?()=>onNav("cards"):null}/>
        <Stat label="Overdue" val={overdue.length} color={C.orange} click={overdue.length?()=>onNav("cards"):null}/>
        <Stat label="Today Tasks" val={`${doneTodos}/${todayTodos.length}`} color={C.green} click={()=>onNav("todo")}/>
        <Stat label="Due in 3 Days" val={soon.length} color={C.yellow} click={soon.length?()=>onNav("cards"):null}/>
      </div>

      {/* Alert card + section breakdown */}
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14}}>

        {/* üö® Due Soon / Overdue card */}
        <div style={{background:C.card,border:`1px solid ${alertItems.length?"#fde68a":C.border}`,borderRadius:12,padding:"16px 18px",borderTop:alertItems.length?`3px solid ${C.orange}`:`3px solid ${C.green}`}}>
          <div style={{fontSize:13,fontWeight:700,color:C.text,marginBottom:3,display:"flex",alignItems:"center",gap:7}}>
            {alertItems.length?"‚ö†Ô∏è Needs Your Attention":"‚úÖ All Clear"}
          </div>
          <div style={{fontSize:11,color:C.t3,marginBottom:12}}>{alertItems.length?`${overdue.length} overdue ¬∑ ${soon.length} due within 3 days`:"Nothing overdue or due soon!"}</div>
          {alertItems.length===0&&<div style={{textAlign:"center",padding:"16px 0",fontSize:24}}>üéâ</div>}
          {alertItems.map(item=>{
            const od=isOD(item.due),sec=getSec(item.section);
            return(
              <div key={item.id} onClick={()=>onEdit(item)} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:od?"#fef2f2":"#fffbeb",borderRadius:8,marginBottom:5,border:`1px solid ${od?"#fca5a8":"#fde68a"}`,cursor:"pointer"}}>
                <span style={{color:sec.color,flexShrink:0}}>{sec.icon}</span>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{fontSize:12,fontWeight:600,color:C.text,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{item.title}</div>
                  {item.workstream&&<div style={{fontSize:10,color:C.t3}}>üìÅ {item.workstream}</div>}
                </div>
                <div style={{flexShrink:0,textAlign:"right"}}>
                  <div style={{fontSize:10,fontWeight:700,color:od?C.red:C.yellow}}>{od?"OVERDUE":"DUE SOON"}</div>
                  <div style={{fontSize:9,color:C.t3}}>{fmt(item.due)}</div>
                </div>
              </div>
            );
          })}
          {alertItems.length>0&&<button onClick={()=>onNav("cards")} style={{width:"100%",marginTop:8,padding:"6px",borderRadius:7,border:`1px solid ${C.border}`,background:"transparent",color:C.accent,fontSize:11,fontWeight:600}}>View all cards ‚Üí</button>}
        </div>

        {/* Section breakdown */}
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"16px 18px"}}>
          <div style={{fontSize:13,fontWeight:700,color:C.text,marginBottom:12}}>Open by Section</div>
          {bySec.map(sec=>(
            <div key={sec.id} style={{marginBottom:10}}>
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                <span style={{fontSize:12,color:sec.color,fontWeight:600}}>{sec.icon} {sec.label}</span>
                <span style={{fontSize:11,color:C.t3}}>{sec.open} open</span>
              </div>
              <div style={{height:5,background:C.bg,borderRadius:3,overflow:"hidden"}}>
                <div style={{height:5,width:`${sec.total?Math.round(((sec.total-sec.open)/sec.total)*100):0}%`,background:sec.color,borderRadius:3,transition:"width 0.4s"}}/>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Today's to-dos mini */}
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"16px 18px"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}}>
          <div style={{fontSize:13,fontWeight:700,color:C.text}}>‚úÖ Today's Tasks</div>
          <button onClick={()=>onNav("todo")} style={{fontSize:11,color:C.accent,background:"transparent",border:"none",fontWeight:600}}>Open To-Do ‚Üí</button>
        </div>
        {todayTodos.length===0&&<div style={{fontSize:12,color:C.t3}}>No tasks yet ‚Äî open To-Do to add some</div>}
        {todayTodos.slice(0,5).map(t=>(
          <div key={t.id} style={{display:"flex",alignItems:"center",gap:8,padding:"6px 0",borderBottom:`1px solid ${C.border}`}}>
            <span style={{fontSize:14,color:t.done?C.green:C.t3}}>{t.done?"‚úì":"‚óã"}</span>
            <span style={{fontSize:12,color:t.done?C.t3:C.text,textDecoration:t.done?"line-through":"none",flex:1}}>{t.text}</span>
          </div>
        ))}
        {todayTodos.length>5&&<div style={{fontSize:11,color:C.t3,marginTop:6}}>+{todayTodos.length-5} more in To-Do</div>}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ MEETING PREP ‚îÄ‚îÄ */
function MeetingPrep({items,onEdit,onStartNote}){
  const dow=new Date().getDay();
  const suggested=dow===1?TMPLS.events:dow===5?TMPLS.osp:TMPLS.supervisor;
  const [sel,setSel]=useState(suggested.id);
  const tmpl=TMPLS[sel]||suggested;
  const sec=getSec(tmpl.section);
  const carries=items.filter(i=>i.section===tmpl.section&&i.status!=="done"&&i.status!=="archived"&&i.carryOver);
  const overdues=items.filter(i=>i.section===tmpl.section&&isOD(i.due)&&i.status!=="done");
  return(
    <div style={{display:"grid",gridTemplateColumns:"240px 1fr",gap:16,alignItems:"start"}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"14px"}}>
        <div style={{fontSize:10,fontWeight:700,color:C.t2,letterSpacing:"0.07em",marginBottom:10}}>SELECT MEETING</div>
        <div style={{fontSize:11,color:C.t3,marginBottom:10}}>Today: {new Date().toLocaleDateString("en-US",{weekday:"long"})}</div>
        {ALL_TMPLS.map(t=>{
          const s=getSec(t.section),active=sel===t.id;
          return(
            <button key={t.id} onClick={()=>setSel(t.id)} style={{width:"100%",textAlign:"left",padding:"9px 11px",borderRadius:9,border:`1px solid ${active?s.color:C.border}`,background:active?s.color+"12":"transparent",marginBottom:5,display:"flex",alignItems:"center",gap:8}}>
              <span style={{color:s.color,fontSize:14}}>{s.icon}</span>
              <div>
                <div style={{fontSize:12,fontWeight:active?600:400,color:active?s.color:C.t2}}>{t.title}</div>
                {t.id===suggested.id&&<div style={{fontSize:9,color:s.color,marginTop:1}}>‚ú¶ Suggested today</div>}
              </div>
            </button>
          );
        })}
      </div>
      <div style={{display:"flex",flexDirection:"column",gap:12}}>
        <div style={{background:sec.color+"0e",border:`1px solid ${sec.color}33`,borderRadius:12,padding:"15px 18px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div>
            <div style={{fontSize:15,fontWeight:700,color:C.text,fontFamily:"'Lora',serif"}}>{tmpl.title}</div>
            {tmpl.attendees&&<div style={{fontSize:11,color:C.t3,marginTop:3}}>üë• {tmpl.attendees}</div>}
          </div>
          <button onClick={()=>onStartNote(tmpl)} style={{padding:"9px 18px",borderRadius:9,border:"none",background:sec.color,color:"#fff",fontSize:13,fontWeight:600}}>üìù Open Notes ‚Üí</button>
        </div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"15px 18px"}}>
          <div style={{fontSize:11,fontWeight:700,color:C.t2,letterSpacing:"0.06em",marginBottom:10}}>üìã STANDARD AGENDA</div>
          {tmpl.agenda.split("\n").filter(Boolean).map((line,i)=>(
            <div key={i} style={{fontSize:13,color:C.text,padding:"6px 0",borderBottom:`1px solid ${C.border}`,display:"flex",gap:8}}>
              <span style={{color:sec.color,fontWeight:700,flexShrink:0}}>{i+1}.</span>
              <span>{line.replace(/^\d+\.\s*/,"")}</span>
            </div>
          ))}
        </div>
        {carries.length>0&&(
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"15px 18px"}}>
            <div style={{fontSize:11,fontWeight:700,color:"#92400e",letterSpacing:"0.06em",marginBottom:10}}>‚Üª CARRY-OVERS TO DISCUSS ({carries.length})</div>
            {carries.map(item=>(
              <div key={item.id} onClick={()=>onEdit(item)} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 10px",borderRadius:8,marginBottom:5,background:C.cream,cursor:"pointer",borderLeft:`3px solid ${getPri(item.priority).color}`}}>
                <span style={{flex:1,fontSize:12,fontWeight:500,color:C.text,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{item.title}</span>
                <Tag c={getStat(item.status).dot} label={getStat(item.status).label} sm/>
                {item.due&&<span style={{fontSize:10,color:isOD(item.due)?C.red:C.t3}}>{isOD(item.due)?"‚è∞ ":""}{fmt(item.due)}</span>}
              </div>
            ))}
          </div>
        )}
        {overdues.length>0&&(
          <div style={{background:"#fef2f2",border:"1px solid #fca5a8",borderRadius:12,padding:"14px 18px"}}>
            <div style={{fontSize:11,fontWeight:700,color:C.red,letterSpacing:"0.06em",marginBottom:8}}>‚è∞ OVERDUE ‚Äî Raise in this meeting ({overdues.length})</div>
            {overdues.map(item=>(
              <div key={item.id} style={{fontSize:12,color:C.text,padding:"4px 0",display:"flex",gap:8}}>
                <span style={{color:C.red}}>!</span><span style={{flex:1}}>{item.title}</span>
                <span style={{fontSize:10,color:C.red}}>{fmt(item.due)}</span>
              </div>
            ))}
          </div>
        )}
        {!carries.length&&!overdues.length&&(
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"24px",textAlign:"center",color:C.t3}}>
            <div style={{fontSize:24,marginBottom:8}}>‚ú®</div>
            <div style={{fontSize:13,color:C.t2,fontWeight:500}}>All clear for this section!</div>
          </div>
        )}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ */
function Notes({section,items,settings,onSave,onEdit,initTmpl,clearTmpl}){
  const sec0=section==="all"?"supervisor":section;
  const [sec,setSec]=useState(sec0);
  const S=getSec(sec);
  const dt=initTmpl||TMPLS[sec]||TMPLS.supervisor;
  const [mode,setMode]=useState("template");
  const [title,setTitle]=useState(initTmpl?dt.title+" ‚Äî "+fmt(today()):"");
  const [attendees,setAttendees]=useState(dt.attendees||"");
  const [ws,setWs]=useState("");
  const [startDate,setStartDate]=useState(today());
  const [due,setDue]=useState(today());
  const [pri,setPri]=useState("normal");
  const [jira,setJira]=useState("");
  const [fields,setFields]=useState({agenda:dt.agenda||"",decisions:"",actions:"",nextsteps:"",blockers:"",notes:""});
  const [blank,setBlank]=useState("");
  const [linked,setLinked]=useState([]);
  const [showLink,setShowLink]=useState(false);
  const [linkQ,setLinkQ]=useState("");
  const [saved,setSaved]=useState(false);
  const [aiLoading,setAiLoading]=useState(false);
  const [aiItems,setAiItems]=useState([]);
  const [showAI,setShowAI]=useState(false);

  const carries=useMemo(()=>items.filter(i=>i.section===sec&&i.status!=="done"&&i.status!=="archived"&&i.carryOver&&i.date>=lastWeek()),[items,sec]);
  const recent=useMemo(()=>items.filter(i=>i.section===sec&&i.status!=="archived").slice(0,4),[items,sec]);
  const linkable=useMemo(()=>items.filter(i=>!linked.includes(i.id)&&(!linkQ||i.title.toLowerCase().includes(linkQ.toLowerCase()))),[items,linked,linkQ]);
  const linkedObjs=linked.map(id=>items.find(i=>i.id===id)).filter(Boolean);

  useEffect(()=>{
    if(!initTmpl){
      const t=TMPLS[sec]||TMPLS.supervisor;
      setTitle("");setAttendees(t.attendees||"");setWs("");
      setFields({agenda:t.agenda||"",decisions:"",actions:"",nextsteps:"",blockers:"",notes:""});
      setLinked([]);setBlank("");setStartDate(today());setDue(today());setAiItems([]);setShowAI(false);
    }
  },[sec]);

  function loadTmpl(t){
    setTitle(t.title+" ‚Äî "+fmt(today()));
    setAttendees(t.attendees||"");
    setFields({agenda:t.agenda||"",decisions:"",actions:"",nextsteps:"",blockers:"",notes:""});
    setSec(t.section);setMode("template");
  }
  function saveCard(){
    if(!title.trim())return;
    onSave({id:Date.now(),section:sec,title,attendees,workstream:ws,...fields,blankNotes:blank,priority:pri,status:"pending",owner:"Salma",jira,startDate,due,carryOver:true,date:today(),type:sec==="meetings"?"meeting":"checkin",linkedItems:linked});
    setSaved(true);setTimeout(()=>setSaved(false),2000);
    const t=TMPLS[sec]||TMPLS.supervisor;
    setTitle("");setAttendees(t.attendees||"");setWs("");setLinked([]);setBlank("");
    setFields({agenda:t.agenda||"",decisions:"",actions:"",nextsteps:"",blockers:"",notes:""});
    setAiItems([]);setShowAI(false);if(clearTmpl)clearTmpl();
  }
  async function runAI(){
    const txt=[fields.agenda,fields.decisions,fields.actions,fields.nextsteps,fields.blockers,fields.notes,blank].filter(Boolean).join("\n");
    if(!txt.trim()){alert("Add some notes first!");return;}
    setAiLoading(true);setShowAI(true);
    try{
      const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:`Extract all action items from these meeting notes. Return ONLY a JSON array, no markdown. Each item: {"title":"short task","owner":"person (default Salma)","due":"YYYY-MM-DD or null","raw":"original line"}\n\n${txt}`}]})});
      const data=await res.json();
      const txt2=(data.content||[]).map(c=>c.text||"").join("").replace(/```json|```/g,"").trim();
      setAiItems(JSON.parse(txt2).map((a,i)=>({...a,id:`ai${i}`,sel:true})));
    }catch(e){console.error(e);setAiItems([]);}
    setAiLoading(false);
  }
  function convertAI(){
    aiItems.filter(a=>a.sel).forEach(a=>{
      onSave({id:Date.now()+Math.random(),section:sec,title:a.title,workstream:ws,agenda:"",decisions:"",actions:a.raw||"",nextsteps:"",blockers:"",notes:"",priority:"normal",status:"pending",owner:a.owner||"Salma",jira:"",startDate:today(),due:a.due||"",carryOver:true,date:today(),type:"checkin",linkedItems:[],attendees:""});
    });
    setAiItems([]);setShowAI(false);setSaved(true);setTimeout(()=>setSaved(false),2000);
  }

  const inp={width:"100%",background:C.cream,border:`1px solid ${C.border}`,borderRadius:8,padding:"8px 11px",color:C.text,fontSize:13,outline:"none"};
  return(
    <div style={{display:"grid",gridTemplateColumns:"1fr 295px",gap:16,alignItems:"start"}}>
      <Datalists/>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden",display:"flex",flexDirection:"column"}}>
        {/* Header */}
        <div style={{padding:"12px 16px",borderBottom:`1px solid ${C.border}`,background:S.color+"08",display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
          <span style={{fontSize:18,color:S.color}}>{S.icon}</span>
          <Sel value={sec} onChange={e=>setSec(e.target.value)} opts={SECTIONS.filter(s=>s.id!=="all").map(s=>({id:s.id,label:s.label}))}/>
          <div style={{flex:1}}/>
          {ALL_TMPLS.filter(t=>t.section===sec).map(t=>(
            <button key={t.id} onClick={()=>loadTmpl(t)} style={{padding:"4px 9px",borderRadius:7,border:`1px solid ${S.color}`,background:S.color+"15",color:S.color,fontSize:10,fontWeight:600,whiteSpace:"nowrap"}}>‚Ü∫ {t.title}</button>
          ))}
          <button onClick={()=>setMode("blank")} style={{padding:"4px 9px",borderRadius:7,border:`1px solid ${mode==="blank"?S.color:C.border}`,background:mode==="blank"?S.color+"18":"transparent",color:mode==="blank"?S.color:C.t2,fontSize:11,fontWeight:600}}>Blank</button>
          <button onClick={()=>setMode("template")} style={{padding:"4px 9px",borderRadius:7,border:`1px solid ${mode==="template"?S.color:C.border}`,background:mode==="template"?S.color+"18":"transparent",color:mode==="template"?S.color:C.t2,fontSize:11,fontWeight:600}}>Template</button>
        </div>

        <div style={{padding:"16px 18px",overflowY:"auto",flex:1,maxHeight:"calc(100vh - 260px)"}}>
          {/* Carry-overs */}
          {carries.length>0&&(
            <div style={{background:"#fffbeb",border:"1px solid #fde68a",borderRadius:10,padding:"10px 13px",marginBottom:14}}>
              <div style={{fontSize:10,fontWeight:700,color:"#92400e",marginBottom:6}}>‚Üª CARRY-OVERS FROM LAST WEEK ({carries.length})</div>
              {carries.map(item=>(
                <div key={item.id} style={{display:"flex",alignItems:"center",gap:8,marginBottom:4,fontSize:12}}>
                  <span style={{color:getPri(item.priority).color}}>‚óè</span>
                  <span style={{flex:1,color:C.text,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{item.title}</span>
                  <Tag c={getStat(item.status).dot} label={getStat(item.status).label} sm/>
                  {item.due&&<span style={{fontSize:10,color:isOD(item.due)?C.red:C.t3}}>{isOD(item.due)?"‚è∞ ":""}{fmt(item.due)}</span>}
                  <button onClick={()=>setLinked(l=>l.includes(item.id)?l:[...l,item.id])} style={{fontSize:9,color:C.accent,background:C.accent+"15",border:`1px solid ${C.accent}33`,borderRadius:5,padding:"1px 5px",fontWeight:600}}>Link</button>
                </div>
              ))}
            </div>
          )}

          {/* Title */}
          <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Title / topic‚Ä¶"
            style={{width:"100%",border:"none",borderBottom:`2px solid ${title?S.color:C.border}`,background:"transparent",fontSize:18,fontWeight:600,color:C.text,outline:"none",padding:"2px 0 10px",marginBottom:13,fontFamily:"'Lora',serif",transition:"border-color .2s"}}/>

          {/* Meta grid */}
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:9,marginBottom:13}}>
            {(sec==="meetings"||sec==="events")&&<div style={{gridColumn:"1/-1"}}><Lbl>ATTENDEES</Lbl><input value={attendees} onChange={e=>setAttendees(e.target.value)} list="team" placeholder="e.g. Japeck, Rachel, Alena‚Ä¶" style={inp}/></div>}
            <div><Lbl>WORK STREAM</Lbl><input value={ws} onChange={e=>setWs(e.target.value)} list="ws" placeholder="Select or type‚Ä¶" style={inp}/></div>
            <div><Lbl>START DATE</Lbl><input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} style={inp}/></div>
            <div><Lbl>DUE DATE</Lbl><input type="date" value={due} onChange={e=>setDue(e.target.value)} style={inp}/></div>
            <div><Lbl>PRIORITY</Lbl><Sel value={pri} onChange={e=>setPri(e.target.value)} opts={PRIS}/></div>
            <div><Lbl>JIRA</Lbl><input value={jira} onChange={e=>setJira(e.target.value)} placeholder="TDPGM-9217" style={{...inp,fontFamily:"'DM Mono',monospace"}}/></div>
          </div>

          {/* Link items */}
          <div style={{marginBottom:13}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:5}}>
              <Lbl>üîó LINK TO EXISTING ITEMS</Lbl>
              <button onClick={()=>setShowLink(p=>!p)} style={{fontSize:11,color:C.accent,background:"transparent",border:`1px solid ${C.accent}`,borderRadius:6,padding:"2px 7px",fontWeight:600}}>+ Link</button>
            </div>
            {linkedObjs.length>0&&<div style={{display:"flex",flexWrap:"wrap",gap:5,marginBottom:7}}>
              {linkedObjs.map(li=><div key={li.id} style={{display:"flex",alignItems:"center",gap:4,background:C.cream,border:`1px solid ${C.border}`,borderRadius:6,padding:"3px 7px",fontSize:11}}>
                <span style={{color:getSec(li.section).color}}>{getSec(li.section).icon}</span>
                <span style={{color:C.text,maxWidth:140,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{li.title}</span>
                <button onClick={()=>setLinked(l=>l.filter(id=>id!==li.id))} style={{background:"transparent",border:"none",color:C.t3,fontSize:10}}>‚úï</button>
              </div>)}
            </div>}
            {showLink&&<div style={{background:C.cream,border:`1px solid ${C.border}`,borderRadius:9,padding:9}}>
              <input value={linkQ} onChange={e=>setLinkQ(e.target.value)} placeholder="Search items‚Ä¶" style={{...inp,marginBottom:7}}/>
              <div style={{maxHeight:140,overflowY:"auto"}}>
                {linkable.slice(0,15).map(li=><div key={li.id} onClick={()=>{setLinked(l=>[...l,li.id]);setShowLink(false);setLinkQ("");}} style={{padding:"6px 8px",borderRadius:6,cursor:"pointer",display:"flex",alignItems:"center",gap:6,fontSize:11}} onMouseEnter={e=>e.currentTarget.style.background=C.card} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                  <span style={{color:getSec(li.section).color}}>{getSec(li.section).icon}</span>
                  <span style={{flex:1,color:C.text}}>{li.title}</span>
                  <Tag c={getStat(li.status).dot} label={getStat(li.status).label} sm/>
                </div>)}
              </div>
            </div>}
          </div>

          {/* BLANK mode */}
          {mode==="blank"&&(
            <textarea value={blank} onChange={e=>setBlank(e.target.value)}
              placeholder={"Free-form notes...\n\nJot anything here ‚Äî ideas, reminders, follow-ups.\nNo structure needed. Hit 'Save as Card' when ready."}
              rows={14} style={{width:"100%",background:"transparent",border:"none",resize:"none",outline:"none",fontSize:14,color:C.text,lineHeight:1.9,fontFamily:"'DM Sans',sans-serif"}}/>
          )}

          {/* TEMPLATE mode */}
          {mode==="template"&&(
            <div>{TFIELDS.map((f,i)=>(
              <div key={f.key} style={{borderBottom:i<TFIELDS.length-1?`1px solid ${C.border}`:"none",paddingBottom:12,marginBottom:12}}>
                <div style={{fontSize:11,fontWeight:700,color:S.color,letterSpacing:"0.06em",marginBottom:5}}>{f.icon} {f.label.toUpperCase()}</div>
                <textarea value={fields[f.key]} onChange={e=>setFields(v=>({...v,[f.key]:e.target.value}))} placeholder={f.ph} rows={f.key==="agenda"?4:3}
                  style={{width:"100%",background:fields[f.key]?C.card:C.cream,border:`1px solid ${fields[f.key]?S.color+"44":C.border}`,borderRadius:8,padding:"8px 11px",resize:"vertical",outline:"none",fontSize:13,color:C.text,lineHeight:1.7,transition:"border-color .2s"}}/>
              </div>
            ))}</div>
          )}

          {/* AI panel */}
          {showAI&&(
            <div style={{marginTop:13,background:"#f0f0ff",border:`1px solid ${C.accent}44`,borderRadius:12,padding:"13px 15px"}}>
              <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:9}}>
                <div style={{fontSize:12,fontWeight:700,color:C.accent}}>ü§ñ AI-Extracted Action Items</div>
                <button onClick={()=>setShowAI(false)} style={{background:"transparent",border:"none",color:C.t3,fontSize:12}}>‚úï</button>
              </div>
              {aiLoading&&<div style={{textAlign:"center",padding:"16px 0",color:C.t2,fontSize:13}}><span className="spin">‚è≥</span> Analyzing notes‚Ä¶</div>}
              {!aiLoading&&aiItems.length===0&&<div style={{fontSize:12,color:C.t3,textAlign:"center",padding:"8px 0"}}>No action items found ‚Äî try adding more detail</div>}
              {!aiLoading&&aiItems.map((a,i)=>(
                <div key={a.id} style={{display:"flex",gap:8,alignItems:"flex-start",padding:"7px 9px",background:a.sel?C.card:"transparent",borderRadius:8,marginBottom:4,border:`1px solid ${a.sel?C.accent+"33":C.border}`}}>
                  <input type="checkbox" checked={a.sel} onChange={()=>setAiItems(items=>items.map((ai,ii)=>ii===i?{...ai,sel:!ai.sel}:ai))} style={{marginTop:3,accentColor:C.accent}}/>
                  <div style={{flex:1}}>
                    <div style={{fontSize:12,fontWeight:600,color:C.text}}>{a.title}</div>
                    {a.owner&&<span style={{fontSize:10,color:C.accent}}>üë§ {a.owner}</span>}
                    {a.due&&<span style={{fontSize:10,color:C.t3,marginLeft:8}}>üìÖ {fmt(a.due)}</span>}
                    <div style={{fontSize:10,color:C.t3,fontStyle:"italic",marginTop:1}}>"{(a.raw||"").slice(0,70)}"</div>
                  </div>
                </div>
              ))}
              {!aiLoading&&aiItems.length>0&&<button onClick={convertAI} style={{width:"100%",marginTop:7,padding:"8px",borderRadius:8,border:"none",background:C.accent,color:"#fff",fontSize:12,fontWeight:600}}>‚úì Convert {aiItems.filter(a=>a.sel).length} to Cards</button>}
            </div>
          )}
        </div>

        {/* Save bar */}
        <div style={{padding:"10px 16px",borderTop:`1px solid ${C.border}`,display:"flex",gap:8,alignItems:"center",background:C.cream,flexShrink:0}}>
          <button onClick={runAI} disabled={aiLoading} style={{padding:"7px 13px",borderRadius:8,border:`1px solid ${C.accent}`,background:C.accent+"10",color:C.accent,fontSize:12,fontWeight:600,display:"flex",alignItems:"center",gap:5}}>
            {aiLoading?<span className="spin">‚è≥</span>:"ü§ñ"} Extract Tasks
          </button>
          <div style={{flex:1,fontSize:11,color:C.t3}}>{!title.trim()?"Add a title to save":linked.length>0?`üîó ${linked.length} linked`:"Ready to save"}</div>
          <button onClick={saveCard} disabled={!title.trim()} style={{padding:"8px 20px",borderRadius:8,border:"none",background:saved?"#10b981":title.trim()?S.color:"#d4c9bb",color:"#fff",fontSize:13,fontWeight:600,transition:"background .3s",cursor:title.trim()?"pointer":"default"}}>
            {saved?"‚úì Saved!":"Save as Card ‚Üí"}
          </button>
        </div>
      </div>

      {/* Right sidebar */}
      <div style={{display:"flex",flexDirection:"column",gap:12}}>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"13px 14px"}}>
          <div style={{fontSize:10,fontWeight:700,color:C.t2,letterSpacing:"0.06em",marginBottom:9}}>RECENT IN SECTION</div>
          {!recent.length&&<div style={{fontSize:12,color:C.t3,textAlign:"center",padding:"10px 0"}}>No items yet</div>}
          {recent.map(item=>(
            <div key={item.id} onClick={()=>onEdit(item)} style={{background:C.bg,border:`1px solid ${C.border}`,borderRadius:8,padding:"8px 10px",marginBottom:5,cursor:"pointer",borderLeft:`3px solid ${getSec(item.section).color}`}}>
              <div style={{fontSize:12,fontWeight:600,color:C.text,marginBottom:3,lineHeight:1.3}}>{item.title}</div>
              <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                <Tag c={getPri(item.priority).color} label={getPri(item.priority).label} sm/>
                <span style={{fontSize:9,color:C.t3,display:"flex",alignItems:"center",gap:2}}>
                  <span style={{width:5,height:5,borderRadius:"50%",background:getStat(item.status).dot,display:"inline-block"}}/>{getStat(item.status).label}
                </span>
              </div>
            </div>
          ))}
        </div>
        <div style={{background:C.accent+"0e",border:`1px solid ${C.accent}33`,borderRadius:12,padding:"12px 14px"}}>
          <div style={{fontSize:10,fontWeight:700,color:C.accent,letterSpacing:"0.06em",marginBottom:8}}>‚Ü∫ ALL TEMPLATES</div>
          {ALL_TMPLS.map(t=><button key={t.id} onClick={()=>loadTmpl(t)} style={{width:"100%",textAlign:"left",padding:"6px 9px",borderRadius:7,border:`1px solid ${C.accent}22`,background:"transparent",color:C.t2,fontSize:11,marginBottom:3,display:"flex",alignItems:"center",gap:6}} onMouseEnter={e=>e.currentTarget.style.background=C.card} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
            <span style={{color:getSec(t.section).color}}>{getSec(t.section).icon}</span>{t.label}
          </button>)}
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
function Cards({items,settings,onEdit,onDelete,onCycle,onArchive,all}){
  const [q,setQ]=useState(""),[fp,setFp]=useState("all"),[fs,setFs]=useState("all"),[showDone,setShowDone]=useState(false);
  const filtered=useMemo(()=>items.filter(i=>{
    if(!showDone&&i.status==="done")return false;
    if(fp!=="all"&&i.priority!==fp)return false;
    if(fs!=="all"&&i.status!==fs)return false;
    if(q){const lq=q.toLowerCase();return i.title.toLowerCase().includes(lq)||(i.agenda||"").toLowerCase().includes(lq)||(i.jira||"").toLowerCase().includes(lq)||(i.workstream||"").toLowerCase().includes(lq);}
    return true;
  }).sort((a,b)=>{const po={urgent:0,high:1,normal:2,low:3},so={blocked:0,pending:1,inprogress:2,done:3};if(po[a.priority]!==po[b.priority])return po[a.priority]-po[b.priority];return so[a.status]-so[b.status];}),[items,q,fp,fs,showDone]);
  const inp={background:C.bg,border:`1px solid ${C.border}`,borderRadius:8,padding:"6px 10px",color:C.text,fontSize:12,outline:"none"};
  return(
    <div>
      <div style={{display:"flex",gap:8,marginBottom:14,flexWrap:"wrap"}}>
        <input value={q} onChange={e=>setQ(e.target.value)} placeholder="Search cards‚Ä¶" style={{...inp,flex:1,minWidth:140}}/>
        <select value={fp} onChange={e=>setFp(e.target.value)} style={inp}><option value="all">All Priorities</option>{PRIS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}</select>
        <select value={fs} onChange={e=>setFs(e.target.value)} style={inp}><option value="all">All Statuses</option>{STATS.filter(s=>s.id!=="archived").map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
        <button onClick={()=>setShowDone(d=>!d)} style={{padding:"6px 10px",borderRadius:8,border:`1px solid ${C.border}`,background:showDone?C.accent+"18":"transparent",color:showDone?C.accent:C.t2,fontSize:12}}>{showDone?"Hide Done":"Show Done"}</button>
      </div>
      {!filtered.length&&<div style={{textAlign:"center",color:C.t3,padding:"50px 0"}}><div style={{fontSize:36,marginBottom:10}}>‚óà</div><div style={{fontSize:14}}>No items ‚Äî start in Notes!</div></div>}
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(310px,1fr))",gap:12}}>
        {filtered.map(item=><ItemCard key={item.id} item={item} settings={settings} onEdit={onEdit} onDelete={onDelete} onCycle={onCycle} onArchive={onArchive} all={all}/>)}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
function Search({items,todos,settings,onEdit}){
  const [q,setQ]=useState("");
  const ref=useRef();
  useEffect(()=>ref.current?.focus(),[]);
  const results=useMemo(()=>{
    if(!q.trim())return[];
    const lq=q.toLowerCase();
    return items.filter(i=>[i.title,i.agenda,i.decisions,i.actions,i.nextsteps,i.blockers,i.notes,i.attendees,i.jira,i.workstream].some(f=>f&&f.toLowerCase().includes(lq))).sort((a,b)=>{const at=a.title.toLowerCase().includes(lq),bt=b.title.toLowerCase().includes(lq);if(at&&!bt)return -1;if(bt&&!at)return 1;return 0;});
  },[items,q]);
  const todoR=useMemo(()=>q.trim()?todos.filter(t=>t.text.toLowerCase().includes(q.toLowerCase())):[],[todos,q]);
  return(
    <div style={{maxWidth:760}}>
      <div style={{background:C.card,border:`2px solid ${q?C.accent:C.border}`,borderRadius:12,padding:"10px 15px",display:"flex",alignItems:"center",gap:10,marginBottom:18,transition:"border-color .2s"}}>
        <span style={{fontSize:18,color:C.t3}}>üîç</span>
        <input ref={ref} value={q} onChange={e=>setQ(e.target.value)} placeholder="Search titles, decisions, action items, Jira tickets, attendees‚Ä¶"
          style={{flex:1,border:"none",background:"transparent",fontSize:15,color:C.text,outline:"none"}}/>
        {q&&<button onClick={()=>setQ("")} style={{background:"transparent",border:"none",color:C.t3,fontSize:14}}>‚úï</button>}
      </div>
      {!q&&<div style={{textAlign:"center",padding:"40px 0",color:C.t3}}><div style={{fontSize:36,marginBottom:10}}>üîç</div><div style={{fontSize:14,fontWeight:600,color:C.t2,marginBottom:5}}>Search everything</div><div style={{fontSize:12}}>Titles, notes, decisions, action items, Jira tickets, archived items</div></div>}
      {q&&!results.length&&!todoR.length&&<div style={{textAlign:"center",padding:"40px 0",color:C.t3}}><div style={{fontSize:30,marginBottom:8}}>ü§∑</div><div style={{fontSize:14,color:C.t2}}>No results for "<strong>{q}</strong>"</div></div>}
      {q&&(results.length>0||todoR.length>0)&&(
        <div>
          <div style={{fontSize:12,color:C.t3,marginBottom:10,fontWeight:600}}>{results.length+todoR.length} result{results.length+todoR.length!==1?"s":""} for "<strong style={{color:C.text}}>{q}</strong>"</div>
          <div style={{display:"flex",flexDirection:"column",gap:9}}>
            {results.map(item=><ItemCard key={item.id} item={item} settings={settings} onEdit={onEdit} onDelete={null} onCycle={null} all={items} q={q}/>)}
            {todoR.map(t=><div key={t.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:"11px 14px",display:"flex",alignItems:"center",gap:10}}>
              <span style={{color:t.done?C.green:C.t3,fontSize:13}}>{t.done?"‚úì":"‚óã"}</span>
              <span style={{fontSize:13,color:t.done?C.t3:C.text,flex:1,textDecoration:t.done?"line-through":"none"}}>{hl(t.text,q)}</span>
              <Tag c="#94a3b8" label="Quick Task" sm/>
            </div>)}
          </div>
        </div>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
function History({items,onEdit}){
  const [fs,setFs]=useState("all"),[fm,setFm]=useState("all");
  const active=items.filter(i=>i.status!=="archived");
  const months=useMemo(()=>[...new Set(active.map(i=>i.date?.slice(0,7)).filter(Boolean))].sort().reverse(),[active]);
  const filtered=useMemo(()=>active.filter(i=>(fs==="all"||i.section===fs)&&(fm==="all"||i.date?.startsWith(fm))).sort((a,b)=>b.date?.localeCompare(a.date)),[active,fs,fm]);
  const byDate=useMemo(()=>{const m={};filtered.forEach(i=>{const d=i.date||"?";if(!m[d])m[d]=[];m[d].push(i);});return m;},[filtered]);
  const sel={background:C.card,border:`1px solid ${C.border}`,borderRadius:8,padding:"6px 10px",color:C.text,fontSize:12,outline:"none"};
  return(
    <div style={{maxWidth:800}}>
      <div style={{display:"flex",gap:10,marginBottom:14,flexWrap:"wrap",alignItems:"center"}}>
        <div style={{fontSize:14,fontWeight:700,color:C.text,flex:1}}>üìö Notes History</div>
        <select value={fs} onChange={e=>setFs(e.target.value)} style={sel}><option value="all">All Sections</option>{SECTIONS.filter(s=>s.id!=="all").map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
        <select value={fm} onChange={e=>setFm(e.target.value)} style={sel}><option value="all">All Months</option>{months.map(m=><option key={m} value={m}>{new Date(m+"-01").toLocaleDateString("en-US",{month:"long",year:"numeric"})}</option>)}</select>
      </div>
      {!filtered.length&&<div style={{textAlign:"center",color:C.t3,padding:"40px 0"}}><div style={{fontSize:32,marginBottom:8}}>üìö</div><div style={{fontSize:14,color:C.t2}}>No notes yet</div></div>}
      {Object.entries(byDate).map(([date,dateItems])=>(
        <div key={date} style={{marginBottom:18}}>
          <div style={{fontSize:10,fontWeight:700,color:C.t3,letterSpacing:"0.08em",padding:"3px 0 7px",borderBottom:`1px solid ${C.border}`,marginBottom:8}}>{fmtFull(date)}</div>
          <div style={{display:"flex",flexDirection:"column",gap:7}}>
            {dateItems.map(item=>{
              const sec=getSec(item.section),pri=getPri(item.priority),sta=getStat(item.status);
              return(
                <div key={item.id} onClick={()=>onEdit(item)} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:"11px 14px",cursor:"pointer",borderLeft:`3px solid ${sec.color}`,display:"flex",gap:12,alignItems:"center"}}>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:13,fontWeight:600,color:C.text,marginBottom:2}}>{item.title}</div>
                    {item.workstream&&<div style={{fontSize:10,color:C.t3}}>üìÅ {item.workstream}</div>}
                    {item.decisions?.trim()&&<div style={{fontSize:11,color:C.t2,marginTop:3}}>‚úÖ {item.decisions.slice(0,80)}{item.decisions.length>80?"‚Ä¶":""}</div>}
                  </div>
                  <div style={{display:"flex",flexDirection:"column",gap:3,alignItems:"flex-end",flexShrink:0}}>
                    <Tag c={pri.color} label={pri.label} sm/>
                    <span style={{fontSize:9,color:C.t3,display:"flex",alignItems:"center",gap:2}}>
                      <span style={{width:5,height:5,borderRadius:"50%",background:sta.dot,display:"inline-block"}}/>{sta.label}
                    </span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  );
}

/* ‚îÄ‚îÄ ARCHIVE ‚îÄ‚îÄ */
function Archive({items,onUnarchive,onDelete}){
  const archived=items.filter(i=>i.status==="archived").sort((a,b)=>b.date?.localeCompare(a.date));
  return(
    <div style={{maxWidth:800}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:14}}>
        <div style={{fontSize:14,fontWeight:700,color:C.text}}>üóÇ Archive ({archived.length})</div>
        <div style={{fontSize:12,color:C.t3}}>Completed items. Still searchable.</div>
      </div>
      {!archived.length&&<div style={{textAlign:"center",color:C.t3,padding:"40px 0"}}><div style={{fontSize:32,marginBottom:8}}>üóÇ</div><div style={{fontSize:14,color:C.t2}}>Archive is empty</div><div style={{fontSize:12,marginTop:4}}>Mark items Done, then click üóÇ on their card to archive</div></div>}
      <div style={{display:"flex",flexDirection:"column",gap:7}}>
        {archived.map(item=>{const sec=getSec(item.section);return(
          <div key={item.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:"11px 14px",display:"flex",alignItems:"center",gap:10,opacity:.75}}>
            <span style={{color:sec.color,fontSize:13}}>{sec.icon}</span>
            <div style={{flex:1,minWidth:0}}>
              <div style={{fontSize:13,color:C.t2,fontWeight:500}}>{item.title}</div>
              {item.workstream&&<div style={{fontSize:10,color:C.t3}}>üìÅ {item.workstream}</div>}
              <div style={{fontSize:10,color:C.t3,marginTop:1}}>{fmtFull(item.date)}</div>
            </div>
            <button onClick={()=>onUnarchive(item.id)} style={{padding:"4px 9px",borderRadius:7,border:`1px solid ${C.border}`,background:"transparent",color:C.t2,fontSize:11}}>Restore</button>
            <button onClick={()=>onDelete(item.id)} style={{background:"transparent",border:"none",color:C.red,fontSize:11}}>Delete</button>
          </div>
        );})}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ TODO ‚îÄ‚îÄ */
function Todo({items,todos,onChange}){
  const [newTxt,setNewTxt]=useState("");
  const td=today(),tt=todos.filter(t=>t.date===td);
  const urgent=items.filter(i=>i.status!=="done"&&i.status!=="archived"&&["urgent","high"].includes(i.priority));
  function add(){if(!newTxt.trim())return;onChange([...todos,{id:Date.now(),text:newTxt.trim(),done:false,date:td}]);setNewTxt("");}
  return(
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:18,alignItems:"start"}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"18px"}}>
        <div style={{fontSize:14,fontWeight:700,color:C.text,marginBottom:3}}>‚úÖ Today's Quick Tasks</div>
        <div style={{fontSize:11,color:C.t3,marginBottom:14}}>{new Date().toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})}</div>
        <div style={{display:"flex",gap:8,marginBottom:13}}>
          <input value={newTxt} onChange={e=>setNewTxt(e.target.value)} onKeyDown={e=>e.key==="Enter"&&add()} placeholder="Add task‚Ä¶ (Enter)"
            style={{flex:1,background:C.cream,border:`1px solid ${C.border}`,borderRadius:8,padding:"8px 11px",color:C.text,fontSize:13,outline:"none"}}/>
          <button onClick={add} style={{padding:"8px 13px",borderRadius:8,border:"none",background:C.accent,color:"#fff",fontSize:13,fontWeight:600}}>+</button>
        </div>
        {!tt.length&&<div style={{fontSize:13,color:C.t3,textAlign:"center",padding:"18px 0"}}>No tasks yet today</div>}
        {tt.map(t=>(
          <div key={t.id} style={{display:"flex",alignItems:"center",gap:9,padding:"8px 9px",borderRadius:8,marginBottom:3,background:t.done?C.cream:C.bg}}>
            <button onClick={()=>onChange(todos.map(x=>x.id===t.id?{...x,done:!x.done}:x))} style={{width:18,height:18,borderRadius:5,border:`2px solid ${t.done?C.green:C.border}`,background:t.done?C.green:"transparent",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,color:"#fff"}}>{t.done?"‚úì":""}</button>
            <span style={{flex:1,fontSize:13,color:t.done?C.t3:C.text,textDecoration:t.done?"line-through":"none"}}>{t.text}</span>
            <button onClick={()=>onChange(todos.filter(x=>x.id!==t.id))} style={{background:"transparent",border:"none",color:C.t3,fontSize:11}}>‚úï</button>
          </div>
        ))}
        {tt.length>0&&<div style={{marginTop:8,fontSize:11,color:C.t3,textAlign:"right"}}>{tt.filter(t=>t.done).length}/{tt.length} done</div>}
      </div>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"18px"}}>
        <div style={{fontSize:14,fontWeight:700,color:C.text,marginBottom:3}}>üî• Needs Attention</div>
        <div style={{fontSize:11,color:C.t3,marginBottom:14}}>Urgent & High priority items</div>
        {!urgent.length&&<div style={{fontSize:13,color:C.t3,textAlign:"center",padding:"18px 0"}}>Nothing urgent right now üéâ</div>}
        {urgent.map(item=>{const p=getPri(item.priority),s=getSec(item.section);return(
          <div key={item.id} style={{padding:"9px 11px",borderRadius:8,marginBottom:5,background:C.bg,borderLeft:`3px solid ${p.color}`}}>
            <div style={{fontSize:12,fontWeight:600,color:C.text,marginBottom:3}}>{s.icon} {item.title}</div>
            {item.workstream&&<div style={{fontSize:10,color:C.t3}}>üìÅ {item.workstream}</div>}
            <div style={{display:"flex",gap:4,flexWrap:"wrap",marginTop:4}}>
              <Tag c={p.color} label={p.label} sm/>
              {item.due&&<span style={{fontSize:9,color:isOD(item.due)?C.red:C.t3}}>{isOD(item.due)?"‚è∞ ":""}{fmt(item.due)}</span>}
            </div>
          </div>
        );})}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ GANTT ‚îÄ‚îÄ */
function Gantt({items,settings}){
  const [offset,setOffset]=useState(0);
  const COLS=28,withDates=items.filter(i=>i.due&&i.status!=="done"&&i.status!=="archived");
  const start=useMemo(()=>{const d=new Date();d.setDate(d.getDate()-d.getDay()+offset*7);d.setHours(0,0,0,0);return d;},[offset]);
  const days=useMemo(()=>Array.from({length:COLS},(_,i)=>{const d=new Date(start);d.setDate(d.getDate()+i);return d;}),[start]);
  const todayD=useMemo(()=>{const d=new Date();d.setHours(0,0,0,0);return d;},[]);
  const allImp=useMemo(()=>[...( settings.showDOE!==false?DOE_HOLIDAYS:[]),...(settings.importantDates||[])],[settings]);
  function ci(ds){if(!ds)return -1;return Math.round((new Date(ds+"T00:00:00")-start)/86400000);}
  const impByCol=useMemo(()=>{const m={};allImp.forEach(d=>{const c=ci(d.date);if(c>=0&&c<COLS){if(!m[c])m[c]=[];m[c].push(d);}});return m;},[days,allImp]);
  return(
    <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"18px",overflowX:"auto"}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:13}}>
        <div style={{fontSize:14,fontWeight:700,color:C.text}}>üìÖ Gantt ‚Äî 4 Week View</div>
        <div style={{display:"flex",gap:7}}>
          <button onClick={()=>setOffset(o=>o-1)} style={{padding:"5px 10px",borderRadius:7,border:`1px solid ${C.border}`,background:"transparent",color:C.t2,fontSize:12}}>‚Üê Prev</button>
          <button onClick={()=>setOffset(0)} style={{padding:"5px 10px",borderRadius:7,border:`1px solid ${C.accent}`,background:C.accent+"15",color:C.accent,fontSize:12,fontWeight:600}}>Today</button>
          <button onClick={()=>setOffset(o=>o+1)} style={{padding:"5px 10px",borderRadius:7,border:`1px solid ${C.border}`,background:"transparent",color:C.t2,fontSize:12}}>Next ‚Üí</button>
        </div>
      </div>
      <div style={{minWidth:700}}>
        <div style={{display:"grid",gridTemplateColumns:`185px repeat(${COLS},1fr)`,marginBottom:3,borderBottom:`1px solid ${C.border}`,paddingBottom:3}}>
          <div style={{fontSize:9,color:C.t3,fontWeight:700}}>ITEM</div>
          {days.map((d,i)=>{const isT=d.getTime()===todayD.getTime(),isMon=d.getDay()===1||i===0,imp=impByCol[i];return(
            <div key={i} title={imp?.map(x=>x.label).join(", ")} style={{fontSize:8,color:isT?C.accent:imp?C.green:isMon?C.t2:C.t3,fontWeight:isT?700:600,textAlign:"center",background:isT?C.accent+"12":imp?"#f0fdf4":"transparent",borderRadius:2,padding:"1px 0",cursor:imp?"help":"default"}}>
              {isT||isMon?d.toLocaleDateString("en-US",{month:"short",day:"numeric"}):imp?"‚òÖ":""}
            </div>
          );})}
        </div>
        {/* Important dates row */}
        {Object.keys(impByCol).length>0&&(
          <div style={{display:"grid",gridTemplateColumns:`185px repeat(${COLS},1fr)`,marginBottom:3}}>
            <div style={{fontSize:9,color:C.green,fontWeight:700,display:"flex",alignItems:"center"}}>üìÖ Dates</div>
            {days.map((_,i)=>{const imp=impByCol[i];return(
              <div key={i} style={{height:16,display:"flex",alignItems:"center",justifyContent:"center"}}>
                {imp&&<div title={imp.map(x=>x.label).join(", ")} style={{width:"88%",height:12,background:imp[0].type==="holiday"?"#fee2e2":imp[0].type==="break"?"#fef3c7":imp[0].type==="pto"?"#f3e8ff":"#dbeafe",borderRadius:3,display:"flex",alignItems:"center",justifyContent:"center"}}>
                  <span style={{fontSize:6,fontWeight:700,color:imp[0].type==="holiday"?C.red:imp[0].type==="break"?C.yellow:imp[0].type==="pto"?C.purple:C.blue,overflow:"hidden",whiteSpace:"nowrap",padding:"0 2px"}}>{imp[0].label.slice(0,7)}</span>
                </div>}
              </div>
            );})}
          </div>
        )}
        {!withDates.length&&<div style={{fontSize:12,color:C.t3,padding:"24px 0",textAlign:"center"}}>No items with dates yet</div>}
        {withDates.map(item=>{
          const sec=getSec(item.section),pri=getPri(item.priority),od=isOD(item.due),bar=od?C.red:pri.color;
          const si=ci(item.startDate||item.due),ei=ci(item.due);
          return(
            <div key={item.id} style={{display:"grid",gridTemplateColumns:`185px repeat(${COLS},1fr)`,marginBottom:3,alignItems:"center"}}>
              <div style={{fontSize:10,color:C.text,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",paddingRight:7,display:"flex",gap:4,alignItems:"center"}}>
                <span style={{color:sec.color,flexShrink:0}}>{sec.icon}</span><span style={{overflow:"hidden",textOverflow:"ellipsis"}}>{item.title}</span>
              </div>
              {days.map((_,i)=>{
                const isT=days[i].getTime()===todayD.getTime(),inR=i>=Math.max(0,si)&&i<=Math.min(COLS-1,ei);
                const isS=i===si&&si>=0&&si<COLS,isE=i===ei&&ei>=0&&ei<COLS,isDot=si===ei&&isS;
                return(
                  <div key={i} style={{height:24,position:"relative",display:"flex",alignItems:"center"}}>
                    {isT&&<div style={{position:"absolute",top:0,bottom:0,left:"50%",width:1,background:C.accent+"55",zIndex:1}}/>}
                    {inR&&!isDot&&<div style={{position:"absolute",top:4,bottom:4,left:isS?"3px":"0",right:isE?"3px":"0",background:bar+"2e",borderRadius:`${isS?5:0}px ${isE?5:0}px ${isE?5:0}px ${isS?5:0}px`,borderLeft:isS?`2px solid ${bar}`:"none",borderRight:isE?`2px solid ${bar}`:"none",border:`1px solid ${bar}44`}}/>}
                    {isDot&&<div style={{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-50%)",width:9,height:9,borderRadius:"50%",background:bar}}/>}
                    {isE&&!isDot&&inR&&<div style={{position:"absolute",right:3,top:"50%",transform:"translateY(-50%)",fontSize:7,color:bar,fontWeight:700,whiteSpace:"nowrap",zIndex:2}}>{fmt(item.due)}</div>}
                  </div>
                );
              })}
            </div>
          );
        })}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ */
function Cal({items,settings,onEdit}){
  const now=new Date();
  const [yr,setYr]=useState(now.getFullYear()),[mo,setMo]=useState(now.getMonth());
  const dIM=new Date(yr,mo+1,0).getDate(),fD=new Date(yr,mo,1).getDay(),td=today();
  const allImp=[...(settings.showDOE!==false?DOE_HOLIDAYS:[]),...(settings.importantDates||[])];
  const byDate=useMemo(()=>{
    const m={};
    items.filter(i=>i.due&&i.status!=="done"&&i.status!=="archived").forEach(item=>{const d=new Date(item.due+"T00:00:00");if(d.getFullYear()===yr&&d.getMonth()===mo){const k=d.getDate();if(!m[k])m[k]={items:[],imp:[]};m[k].items.push(item);}});
    allImp.forEach(imp=>{const d=new Date(imp.date+"T00:00:00");if(d.getFullYear()===yr&&d.getMonth()===mo){const k=d.getDate();if(!m[k])m[k]={items:[],imp:[]};m[k].imp.push(imp);}});
    return m;
  },[items,yr,mo,settings]);
  const cells=useMemo(()=>{const a=[];for(let i=0;i<fD;i++)a.push(null);for(let i=1;i<=dIM;i++)a.push(i);return a;},[fD,dIM]);
  function prev(){if(mo===0){setMo(11);setYr(y=>y-1);}else setMo(m=>m-1);}
  function next(){if(mo===11){setMo(0);setYr(y=>y+1);}else setMo(m=>m+1);}
  return(
    <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"18px"}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:13}}>
        <div style={{fontSize:14,fontWeight:700,color:C.text}}>üóì {new Date(yr,mo,1).toLocaleDateString("en-US",{month:"long",year:"numeric"})}</div>
        <div style={{display:"flex",gap:7}}>
          <button onClick={prev} style={{padding:"5px 10px",borderRadius:7,border:`1px solid ${C.border}`,background:"transparent",color:C.t2,fontSize:12}}>‚Üê Prev</button>
          <button onClick={()=>{setYr(now.getFullYear());setMo(now.getMonth());}} style={{padding:"5px 10px",borderRadius:7,border:`1px solid ${C.accent}`,background:C.accent+"15",color:C.accent,fontSize:12,fontWeight:600}}>Today</button>
          <button onClick={next} style={{padding:"5px 10px",borderRadius:7,border:`1px solid ${C.border}`,background:"transparent",color:C.t2,fontSize:12}}>Next ‚Üí</button>
        </div>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:1,marginBottom:3}}>
        {["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(d=><div key={d} style={{fontSize:10,color:C.t3,fontWeight:700,textAlign:"center",padding:"3px 0"}}>{d}</div>)}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:3}}>
        {cells.map((day,i)=>{
          if(!day)return <div key={`e${i}`}/>;
          const ds=`${yr}-${String(mo+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`,isT=ds===td,cell=byDate[day]||{items:[],imp:[]};
          const hasHol=cell.imp.some(x=>x.type==="holiday"||x.type==="break");
          return(
            <div key={day} style={{minHeight:78,background:isT?C.accent+"12":hasHol?"#fef9ee":cell.items.length?C.cream:C.bg,borderRadius:8,border:`1px solid ${isT?C.accent:hasHol?"#fde68a":C.border}`,padding:"4px 5px"}}>
              <div style={{fontSize:11,fontWeight:isT?700:400,color:isT?C.accent:C.t3,marginBottom:2}}>{day}</div>
              {cell.imp.map((imp,ii)=><div key={ii} style={{fontSize:7,color:imp.type==="holiday"?C.red:imp.type==="break"?C.yellow:imp.type==="pto"?C.purple:C.blue,fontWeight:700,marginBottom:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>‚òÖ {imp.label}</div>)}
              {cell.items.slice(0,2).map(item=><div key={item.id} onClick={()=>onEdit(item)} title={item.title} style={{fontSize:8,color:C.text,background:getPri(item.priority).color+"20",border:`1px solid ${getPri(item.priority).color}44`,borderRadius:4,padding:"1px 3px",marginBottom:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",cursor:"pointer"}}>{getSec(item.section).icon} {item.title}</div>)}
              {cell.items.length>2&&<div style={{fontSize:8,color:C.t3}}>+{cell.items.length-2} more</div>}
            </div>
          );
        })}
      </div>
      <div style={{marginTop:10,display:"flex",gap:10,flexWrap:"wrap",fontSize:9,color:C.t3}}>
        <span style={{color:C.red}}>‚òÖ Holiday</span><span style={{color:C.yellow}}>‚òÖ Break</span><span style={{color:C.purple}}>‚òÖ PTO</span><span style={{color:C.blue}}>‚òÖ Custom</span>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ MONITOR ‚îÄ‚îÄ */
function Monitor({settings,onOpenSettings}){
  const Board=({title,color,icon,links,empty})=>(
    <div style={{background:C.card,border:`1px solid ${C.border}`,borderLeft:`3px solid ${color}`,borderRadius:12,padding:"14px 17px",marginBottom:11}}>
      <div style={{fontSize:13,fontWeight:700,color:C.text,marginBottom:9}}>{icon} {title}</div>
      {!links.length?<div style={{fontSize:12,color:C.t3}}>{empty}</div>:
        <div style={{display:"flex",flexWrap:"wrap",gap:7}}>
          {links.map((l,i)=><a key={i} href={l.url} target="_blank" rel="noopener noreferrer" style={{display:"inline-flex",alignItems:"center",gap:5,padding:"6px 13px",borderRadius:8,border:`1px solid ${color}44`,background:color+"0e",color,fontSize:12,fontWeight:600}}>{l.name} ‚Üó</a>)}
        </div>}
    </div>
  );
  return(
    <div style={{maxWidth:680}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:14}}>
        <div style={{fontSize:14,fontWeight:700,color:C.text}}>üîó External Tools</div>
        <button onClick={onOpenSettings} style={{padding:"6px 13px",borderRadius:8,border:`1px solid ${C.border}`,background:C.card,color:C.accent,fontSize:12,fontWeight:600}}>‚öô Configure</button>
      </div>
      <Board title="Jira Boards" color={C.blue} icon="‚¨°" links={(settings.jiraBoards||[]).map(b=>({name:b.name,url:`${b.base}/${b.prefix}`}))} empty="No Jira boards configured"/>
      <Board title="Zendesk Queues" color={C.green} icon="‚óà" links={(settings.zendeskBoards||[]).map(b=>({name:b.name,url:`${b.base}/agent`}))} empty="No Zendesk boards configured"/>
      <Board title="Slack Channels" color={C.yellow} icon="#" links={(settings.slackChannels||[]).map(c=>({name:c.name,url:c.workspace?`https://${c.workspace}.slack.com/app_redirect?channel=${c.channel}`:"#"}))} empty="No Slack channels configured"/>
      <Board title="Microsoft Teams" color={C.purple} icon="üí¨" links={(settings.teamsChannels||[]).map(c=>({name:c.name,url:c.url}))} empty="No Teams channels configured"/>
    </div>
  );
}

/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
function Settings({settings,onSave,onClose,items,todos}){
  const [s,setS]=useState(JSON.parse(JSON.stringify(settings)));
  const [nd,setNd]=useState({date:"",label:"",type:"custom"});
  const fileRef=useRef();
  const addJ=()=>setS(v=>({...v,jiraBoards:[...v.jiraBoards,{id:Date.now(),name:"",base:"https://doeord.atlassian.net/browse",prefix:""}]}));
  const delJ=id=>setS(v=>({...v,jiraBoards:v.jiraBoards.filter(b=>b.id!==id)}));
  const upJ=(id,k,val)=>setS(v=>({...v,jiraBoards:v.jiraBoards.map(b=>b.id===id?{...b,[k]:val}:b)}));
  const addZ=()=>setS(v=>({...v,zendeskBoards:[...v.zendeskBoards,{id:Date.now(),name:"",base:""}]}));
  const delZ=id=>setS(v=>({...v,zendeskBoards:v.zendeskBoards.filter(b=>b.id!==id)}));
  const upZ=(id,k,val)=>setS(v=>({...v,zendeskBoards:v.zendeskBoards.map(b=>b.id===id?{...b,[k]:val}:b)}));
  const addSl=()=>setS(v=>({...v,slackChannels:[...v.slackChannels,{id:Date.now(),name:"",workspace:"",channel:""}]}));
  const delSl=id=>setS(v=>({...v,slackChannels:v.slackChannels.filter(c=>c.id!==id)}));
  const upSl=(id,k,val)=>setS(v=>({...v,slackChannels:v.slackChannels.map(c=>c.id===id?{...c,[k]:val}:c)}));
  const addTm=()=>setS(v=>({...v,teamsChannels:[...v.teamsChannels,{id:Date.now(),name:"",url:""}]}));
  const delTm=id=>setS(v=>({...v,teamsChannels:v.teamsChannels.filter(c=>c.id!==id)}));
  const upTm=(id,k,val)=>setS(v=>({...v,teamsChannels:v.teamsChannels.map(c=>c.id===id?{...c,[k]:val}:c)}));
  function addDate(){if(!nd.date||!nd.label)return;setS(v=>({...v,importantDates:[...(v.importantDates||[]),{id:Date.now(),...nd}]}));setNd({date:"",label:"",type:"custom"});}
  function delDate(id){setS(v=>({...v,importantDates:(v.importantDates||[]).filter(d=>d.id!==id)}));}
  function exportData(){const b=new Blob([JSON.stringify({items,todos,settings:s,exportedAt:new Date().toISOString()},null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=`osp-central-${today()}.json`;a.click();}
  function importFile(file){const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(d.items){lsSave("osp-items",d.items);lsSave("osp-todos",d.todos||[]);lsSave("osp-settings",d.settings||{});alert("‚úÖ Restored! Refresh the page.");}}catch{alert("Invalid file.");}};r.readAsText(file);}
  const inp={background:C.cream,border:`1px solid ${C.border}`,borderRadius:7,padding:"7px 10px",color:C.text,fontSize:12,outline:"none"};
  const row={display:"flex",gap:7,alignItems:"center",marginBottom:6};
  const SH=({t,color,onAdd,lbl})=><div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:7,marginTop:3}}><div style={{fontSize:10,fontWeight:700,color,letterSpacing:"0.05em"}}>{t}</div>{onAdd&&<button onClick={onAdd} style={{padding:"2px 9px",borderRadius:5,border:`1px solid ${color}`,background:color+"15",color,fontSize:10,fontWeight:600}}>+ {lbl}</button>}</div>;
  return(
    <div style={{position:"fixed",inset:0,background:"#00000044",display:"flex",alignItems:"center",justifyContent:"center",zIndex:300,padding:20}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:16,padding:24,width:"100%",maxWidth:540,maxHeight:"92vh",overflowY:"auto"}}>
        <div style={{fontSize:15,fontWeight:700,color:C.text,marginBottom:3}}>‚öô Settings & Integrations</div>
        <div style={{fontSize:12,color:C.t3,marginBottom:16}}>Configure boards, channels, and important dates.</div>

        {/* Important dates */}
        <div style={{background:"#f0fdf4",border:"1px solid #bbf7d0",borderRadius:10,padding:"13px 15px",marginBottom:16}}>
          <SH t="üìÖ IMPORTANT DATES" color={C.green}/>
          <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:9}}>
            <input type="checkbox" checked={s.showDOE!==false} onChange={e=>setS(v=>({...v,showDOE:e.target.checked}))} style={{accentColor:C.green}}/>
            <span style={{fontSize:12,color:C.t2}}>Show DOE/NYC school calendar (holidays & breaks)</span>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr auto",gap:5,marginBottom:7}}>
            <input type="date" value={nd.date} onChange={e=>setNd(d=>({...d,date:e.target.value}))} style={{...inp,width:"100%"}}/>
            <input value={nd.label} onChange={e=>setNd(d=>({...d,label:e.target.value}))} placeholder="Label" style={{...inp,width:"100%"}}/>
            <select value={nd.type} onChange={e=>setNd(d=>({...d,type:e.target.value}))} style={{...inp,width:"100%"}}>
              <option value="pto">PTO</option><option value="qc">QC Date</option><option value="release">Release</option><option value="deadline">Deadline</option><option value="custom">Custom</option>
            </select>
            <button onClick={addDate} style={{padding:"7px 11px",borderRadius:7,border:"none",background:C.green,color:"#fff",fontSize:12,fontWeight:600}}>+</button>
          </div>
          {(s.importantDates||[]).map(d=><div key={d.id} style={{display:"flex",alignItems:"center",gap:7,padding:"4px 0",borderBottom:"1px solid #d1fae5",fontSize:11}}><span style={{color:C.green,fontWeight:600}}>{fmt(d.date)}</span><span style={{flex:1,color:C.text}}>{d.label}</span><Tag c={C.green} label={d.type} sm/><button onClick={()=>delDate(d.id)} style={{background:"transparent",border:"none",color:C.red,fontSize:11}}>‚úï</button></div>)}
        </div>

        <SH t="üîµ JIRA BOARDS" color={C.blue} onAdd={addJ} lbl="Add"/>
        {s.jiraBoards.map(b=><div key={b.id} style={row}><input value={b.name} onChange={e=>upJ(b.id,"name",e.target.value)} placeholder="Name" style={{...inp,flex:"0 0 75px"}}/><input value={b.prefix} onChange={e=>upJ(b.id,"prefix",e.target.value)} placeholder="Prefix" style={{...inp,flex:"0 0 80px",fontFamily:"'DM Mono',monospace"}}/><input value={b.base} onChange={e=>upJ(b.id,"base",e.target.value)} placeholder="Base URL" style={{...inp,flex:1}}/><button onClick={()=>delJ(b.id)} style={{background:"transparent",border:"none",color:C.red,fontSize:13}}>‚úï</button></div>)}

        <div style={{borderTop:`1px solid ${C.border}`,marginTop:10,paddingTop:10}}>
          <SH t="üü¢ ZENDESK" color={C.green} onAdd={addZ} lbl="Add"/>
          {s.zendeskBoards.map(b=><div key={b.id} style={row}><input value={b.name} onChange={e=>upZ(b.id,"name",e.target.value)} placeholder="Name" style={{...inp,flex:"0 0 120px"}}/><input value={b.base} onChange={e=>upZ(b.id,"base",e.target.value)} placeholder="https://org.zendesk.com" style={{...inp,flex:1}}/><button onClick={()=>delZ(b.id)} style={{background:"transparent",border:"none",color:C.red,fontSize:13}}>‚úï</button></div>)}
        </div>
        <div style={{borderTop:`1px solid ${C.border}`,marginTop:10,paddingTop:10}}>
          <SH t="üü° SLACK CHANNELS" color={C.yellow} onAdd={addSl} lbl="Add"/>
          {s.slackChannels.map(c=><div key={c.id} style={row}><input value={c.name} onChange={e=>upSl(c.id,"name",e.target.value)} placeholder="#channel" style={{...inp,flex:"0 0 95px"}}/><input value={c.workspace} onChange={e=>upSl(c.id,"workspace",e.target.value)} placeholder="workspace" style={{...inp,flex:1}}/><input value={c.channel} onChange={e=>upSl(c.id,"channel",e.target.value)} placeholder="channel-id" style={{...inp,flex:"0 0 90px"}}/><button onClick={()=>delSl(c.id)} style={{background:"transparent",border:"none",color:C.red,fontSize:13}}>‚úï</button></div>)}
        </div>
        <div style={{borderTop:`1px solid ${C.border}`,marginTop:10,paddingTop:10}}>
          <SH t="üíú TEAMS CHANNELS" color={C.purple} onAdd={addTm} lbl="Add"/>
          {s.teamsChannels.map(c=><div key={c.id} style={row}><input value={c.name} onChange={e=>upTm(c.id,"name",e.target.value)} placeholder="Channel name" style={{...inp,flex:"0 0 130px"}}/><input value={c.url} onChange={e=>upTm(c.id,"url",e.target.value)} placeholder="Teams URL" style={{...inp,flex:1}}/><button onClick={()=>delTm(c.id)} style={{background:"transparent",border:"none",color:C.red,fontSize:13}}>‚úï</button></div>)}
        </div>

        <div style={{borderTop:`1px solid ${C.border}`,marginTop:14,paddingTop:13,marginBottom:14}}>
          <div style={{fontSize:10,fontWeight:700,color:C.t2,marginBottom:7}}>üíæ BACKUP & RESTORE</div>
          <div style={{display:"flex",gap:7}}>
            <button onClick={exportData} style={{flex:1,padding:"8px",borderRadius:8,border:`1px solid ${C.border}`,background:C.cream,color:C.blue,fontSize:12,fontWeight:600}}>‚¨á Export .json</button>
            <button onClick={()=>fileRef.current.click()} style={{flex:1,padding:"8px",borderRadius:8,border:`1px solid ${C.border}`,background:C.cream,color:C.green,fontSize:12,fontWeight:600}}>‚¨Ü Import .json</button>
            <input ref={fileRef} type="file" accept=".json" style={{display:"none"}} onChange={e=>{if(e.target.files[0])importFile(e.target.files[0]);}}/>
          </div>
        </div>
        <div style={{display:"flex",gap:9}}>
          <button onClick={onClose} style={{flex:1,padding:"10px",borderRadius:8,border:`1px solid ${C.border}`,background:"transparent",color:C.t2,fontSize:13}}>Cancel</button>
          <button onClick={()=>{onSave(s);onClose();}} style={{flex:2,padding:"10px",borderRadius:8,border:"none",background:C.accent,color:"#fff",fontSize:13,fontWeight:600}}>Save Settings</button>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ */
function EditModal({item,onSave,onClose,all}){
  const [e,setE]=useState({...item});
  const [lq,setLq]=useState(""),[showL,setShowL]=useState(false);
  const linkedObjs=(e.linkedItems||[]).map(id=>all.find(i=>i.id===id)).filter(Boolean);
  const linkable=all.filter(i=>i.id!==e.id&&!(e.linkedItems||[]).includes(i.id)&&(!lq||i.title.toLowerCase().includes(lq.toLowerCase())));
  const inp={width:"100%",background:C.cream,border:`1px solid ${C.border}`,borderRadius:7,padding:"7px 10px",color:C.text,fontSize:12,outline:"none"};
  return(
    <div style={{position:"fixed",inset:0,background:"#00000044",display:"flex",alignItems:"center",justifyContent:"center",zIndex:200,padding:20}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:16,padding:24,width:"100%",maxWidth:550,maxHeight:"92vh",overflowY:"auto"}}>
        <Datalists/>
        <div style={{fontSize:15,fontWeight:700,color:C.text,marginBottom:14}}>Edit Item</div>
        <div style={{display:"flex",flexDirection:"column",gap:9}}>
          <div><Lbl>TITLE</Lbl><input value={e.title||""} onChange={ev=>setE(i=>({...i,title:ev.target.value}))} style={inp}/></div>
          {e.attendees!==undefined&&<div><Lbl>ATTENDEES</Lbl><input value={e.attendees||""} onChange={ev=>setE(i=>({...i,attendees:ev.target.value}))} list="team" style={inp}/></div>}
          <div><Lbl>WORK STREAM</Lbl><input value={e.workstream||""} onChange={ev=>setE(i=>({...i,workstream:ev.target.value}))} list="ws" style={inp}/></div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:9}}>
            <div><Lbl>SECTION</Lbl><select value={e.section||""} onChange={ev=>setE(i=>({...i,section:ev.target.value}))} style={inp}>{SECTIONS.filter(s=>s.id!=="all").map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select></div>
            <div><Lbl>PRIORITY</Lbl><select value={e.priority||""} onChange={ev=>setE(i=>({...i,priority:ev.target.value}))} style={inp}>{PRIS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}</select></div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:9}}>
            <div><Lbl>STATUS</Lbl><select value={e.status||""} onChange={ev=>setE(i=>({...i,status:ev.target.value}))} style={inp}>{STATS.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select></div>
            <div><Lbl>OWNER</Lbl><input value={e.owner||""} onChange={ev=>setE(i=>({...i,owner:ev.target.value}))} list="team" style={inp}/></div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:9}}>
            <div><Lbl>START DATE</Lbl><input type="date" value={e.startDate||""} onChange={ev=>setE(i=>({...i,startDate:ev.target.value}))} style={inp}/></div>
            <div><Lbl>DUE DATE</Lbl><input type="date" value={e.due||""} onChange={ev=>setE(i=>({...i,due:ev.target.value}))} style={inp}/></div>
            <div><Lbl>JIRA</Lbl><input value={e.jira||""} onChange={ev=>setE(i=>({...i,jira:ev.target.value}))} style={{...inp,fontFamily:"'DM Mono',monospace"}}/></div>
          </div>
          {/* Linked */}
          <div style={{background:C.cream,border:`1px solid ${C.border}`,borderRadius:9,padding:"10px"}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}}><Lbl>üîó LINKED ITEMS</Lbl><button onClick={()=>setShowL(p=>!p)} style={{fontSize:10,color:C.accent,background:"transparent",border:`1px solid ${C.accent}`,borderRadius:5,padding:"2px 7px",fontWeight:600}}>+ Link</button></div>
            {linkedObjs.length>0&&<div style={{display:"flex",flexWrap:"wrap",gap:4,marginBottom:6}}>{linkedObjs.map(li=><div key={li.id} style={{display:"flex",alignItems:"center",gap:4,background:C.card,border:`1px solid ${C.border}`,borderRadius:5,padding:"2px 7px",fontSize:10}}><span style={{color:getSec(li.section).color}}>{getSec(li.section).icon}</span><span style={{maxWidth:130,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{li.title}</span><button onClick={()=>setE(i=>({...i,linkedItems:(i.linkedItems||[]).filter(id=>id!==li.id)}))} style={{background:"transparent",border:"none",color:C.t3,fontSize:9}}>‚úï</button></div>)}</div>}
            {showL&&<><input value={lq} onChange={ev=>setLq(ev.target.value)} placeholder="Search‚Ä¶" style={{...inp,marginBottom:5}}/><div style={{maxHeight:110,overflowY:"auto"}}>{linkable.slice(0,12).map(li=><div key={li.id} onClick={()=>{setE(i=>({...i,linkedItems:[...(i.linkedItems||[]),li.id]}));setShowL(false);setLq("");}} style={{padding:"5px 7px",borderRadius:5,cursor:"pointer",display:"flex",alignItems:"center",gap:5,fontSize:11}} onMouseEnter={e=>e.currentTarget.style.background=C.bg} onMouseLeave={e=>e.currentTarget.style.background="transparent"}><span style={{color:getSec(li.section).color}}>{getSec(li.section).icon}</span><span style={{flex:1}}>{li.title}</span><Tag c={getStat(li.status).dot} label={getStat(li.status).label} sm/></div>)}</div></>}
          </div>
          {TFIELDS.map(f=><div key={f.key}><Lbl>{f.icon} {f.label.toUpperCase()}</Lbl><textarea value={e[f.key]||""} onChange={ev=>setE(i=>({...i,[f.key]:ev.target.value}))} rows={2} placeholder={f.ph} style={{...inp,resize:"vertical"}}/></div>)}
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <div onClick={()=>setE(i=>({...i,carryOver:!i.carryOver}))} style={{width:30,height:16,borderRadius:8,background:e.carryOver?C.accent:C.border,position:"relative",cursor:"pointer",flexShrink:0}}>
              <div style={{width:10,height:10,borderRadius:"50%",background:"#fff",position:"absolute",top:3,left:e.carryOver?17:2,transition:"left .2s"}}/>
            </div>
            <span style={{fontSize:12,color:C.t2}}>Carry over until done</span>
          </div>
        </div>
        <div style={{display:"flex",gap:9,marginTop:16}}>
          <button onClick={onClose} style={{flex:1,padding:"10px",borderRadius:8,border:`1px solid ${C.border}`,background:"transparent",color:C.t2,fontSize:13}}>Cancel</button>
          <button onClick={()=>{if(e.title?.trim())onSave(e);}} style={{flex:2,padding:"10px",borderRadius:8,border:"none",background:C.accent,color:"#fff",fontSize:13,fontWeight:600}}>Save Changes</button>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
function App(){
  const [items,    setItemsRaw]  = useState(()=>lsGet("osp-items",SAMPLE));
  const [todos,    setTodosRaw]  = useState(()=>lsGet("osp-todos",SAMPLE_TODOS));
  const [settings, setSettingsRaw] = useState(()=>lsGet("osp-settings",DEF_SETTINGS));
  const [view,     setView]      = useState("dashboard");
  const [section,  setSection]   = useState("all");
  const [editItem, setEditItem]  = useState(null);
  const [showSettings,setShowSettings] = useState(false);
  const [sidebar,  setSidebar]   = useState(true);
  const [flash,    setFlash]     = useState(false);
  const [prepTmpl, setPrepTmpl]  = useState(null);

  function setItems(v){setItemsRaw(v);lsSave("osp-items",v);pulse();}
  function setTodos(v){setTodosRaw(v);lsSave("osp-todos",v);pulse();}
  function setSettings(v){setSettingsRaw(v);lsSave("osp-settings",v);pulse();}
  function pulse(){setFlash(true);setTimeout(()=>setFlash(false),1500);}

  const active=useMemo(()=>items.filter(i=>i.status!=="archived"),[items]);
  const sectionItems=useMemo(()=>section==="all"?active:active.filter(i=>i.section===section),[active,section]);

  function openEdit(item){setEditItem(item);}
  function saveEdit(e){setItems(items.map(i=>i.id===e.id?e:i));setEditItem(null);}
  function deleteItem(id){setItems(items.filter(i=>i.id!==id));}
  function archiveItem(id){setItems(items.map(i=>i.id===id?{...i,status:"archived"}:i));}
  function unarchiveItem(id){setItems(items.map(i=>i.id===id?{...i,status:"done"}:i));}
  function cycleStatus(item){const idx=STATS.findIndex(s=>s.id===item.status);setItems(items.map(i=>i.id===item.id?{...i,status:STATS[(idx+1)%4].id}:i));}
  function saveNote(item){setItems([item,...items]);}
  function startNoteFromPrep(tmpl){setPrepTmpl(tmpl);setView("notes");}
  function navTo(v){setView(v);}

  // Sidebar badge counts
  const secBadge=useMemo(()=>{
    const m={};
    SECTIONS.forEach(s=>{
      const it=s.id==="all"?active:active.filter(i=>i.section===s.id);
      m[s.id]={open:it.filter(i=>i.status!=="done").length,urgent:it.filter(i=>i.status!=="done"&&["urgent","high"].includes(i.priority)).length,od:it.filter(i=>i.status!=="done"&&isOD(i.due)).length};
    });
    return m;
  },[active]);

  return(
    <div style={{display:"flex",height:"100vh",background:C.bg,overflow:"hidden"}}>
      {flash&&<div style={{position:"fixed",bottom:16,right:16,background:"#ecfdf5",border:"1px solid #6ee7b7",borderRadius:8,padding:"6px 13px",fontSize:11,color:"#059669",fontWeight:600,zIndex:999,pointerEvents:"none",boxShadow:"0 2px 8px #0001"}}>üíæ Saved</div>}

      {/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */}
      <div style={{width:sidebar?252:56,background:C.sb,borderRight:`1px solid ${C.border}`,display:"flex",flexDirection:"column",transition:"width .2s",flexShrink:0,overflow:"hidden"}}>
        {/* Logo */}
        <div style={{padding:"15px 13px 12px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:10}}>
          <div style={{width:30,height:30,background:`linear-gradient(135deg,${C.accent},${C.purple})`,borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:13,flexShrink:0}}>‚¨°</div>
          {sidebar&&<div><div style={{fontSize:13,fontWeight:700,color:C.text,fontFamily:"'Lora',serif"}}>OSP Central</div><div style={{fontSize:9,color:C.t3}}>Salma's Check-In</div></div>}
        </div>

        {/* Sections */}
        <div style={{padding:"10px 7px 4px",overflowY:"auto",flex:1}}>
          {sidebar&&<div style={{fontSize:9,color:C.t3,fontWeight:700,letterSpacing:"0.08em",padding:"3px 9px 5px"}}>SECTIONS</div>}
          {SECTIONS.map(sec=>{
            const active0=section===sec.id,b=secBadge[sec.id]||{};
            return(
              <button key={sec.id} onClick={()=>setSection(sec.id)} style={{width:"100%",display:"flex",alignItems:"center",gap:9,padding:"8px 9px",borderRadius:8,border:"none",background:active0?sec.color+"18":"transparent",color:active0?sec.color:C.t2,marginBottom:2,transition:"all .15s"}}>
                <span style={{fontSize:14,flexShrink:0}}>{sec.icon}</span>
                {sidebar&&<>
                  <span style={{fontSize:12,fontWeight:active0?600:400,flex:1,textAlign:"left",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{sec.label}</span>
                  <div style={{display:"flex",gap:3,flexShrink:0}}>
                    {b.od>0&&<span style={{background:"#fee2e2",color:C.red,fontSize:9,fontWeight:700,padding:"1px 4px",borderRadius:9}}>‚è∞{b.od}</span>}
                    {b.urgent>0&&<span style={{background:"#fff7ed",color:C.orange,fontSize:9,fontWeight:700,padding:"1px 4px",borderRadius:9}}>!{b.urgent}</span>}
                    {b.open>0&&<span style={{background:sec.color+"18",color:sec.color,fontSize:9,fontWeight:600,padding:"1px 4px",borderRadius:9}}>{b.open}</span>}
                  </div>
                </>}
              </button>
            );
          })}

          {sidebar&&<div style={{fontSize:9,color:C.t3,fontWeight:700,letterSpacing:"0.08em",padding:"10px 9px 5px"}}>VIEWS</div>}
          {!sidebar&&<div style={{borderTop:`1px solid ${C.border}44`,marginTop:4,paddingTop:4}}/>}
          {VIEWS.map(v=>{
            const act=view===v.id;
            return(
              <button key={v.id} onClick={()=>setView(v.id)} style={{width:"100%",display:"flex",alignItems:"center",gap:9,padding:"7px 9px",borderRadius:8,border:"none",background:act?C.accent+"18":"transparent",color:act?C.accent:C.t2,marginBottom:1,transition:"all .15s"}}>
                <span style={{fontSize:12,flexShrink:0}}>{v.icon}</span>
                {sidebar&&<span style={{fontSize:12,fontWeight:act?600:400}}>{v.label}</span>}
              </button>
            );
          })}
        </div>

        {/* Bottom */}
        <div style={{padding:"7px",borderTop:`1px solid ${C.border}`}}>
          <button onClick={()=>setShowSettings(true)} style={{width:"100%",padding:"6px 9px",borderRadius:7,border:`1px solid ${C.border}`,background:"transparent",color:C.accent,fontSize:10,fontWeight:600,display:"flex",alignItems:"center",gap:8,marginBottom:3}}>
            <span>‚öô</span>{sidebar&&"Settings & Integrations"}
          </button>
          <button onClick={()=>setSidebar(o=>!o)} style={{width:"100%",padding:"5px 9px",borderRadius:7,border:"none",background:"transparent",color:C.t3,fontSize:11,display:"flex",alignItems:"center",gap:8}}>
            <span style={{fontSize:10}}>{sidebar?"‚óÄ":"‚ñ∂"}</span>{sidebar&&"Collapse"}
          </button>
        </div>
      </div>

      {/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */}
      <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
        {/* Topbar */}
        <div style={{padding:"10px 18px",borderBottom:`1px solid ${C.border}`,display:"flex",alignItems:"center",gap:8,background:C.card,flexShrink:0}}>
          <div style={{flex:1}}>
            <div style={{fontSize:14,fontWeight:700,color:C.text}}>{VIEWS.find(v=>v.id===view)?.icon} {VIEWS.find(v=>v.id===view)?.label}{section!=="all"&&<span style={{fontSize:12,color:getSec(section).color,marginLeft:8,fontWeight:500}}>¬∑ {getSec(section).label}</span>}</div>
            <div style={{fontSize:9,color:C.t3}}>{new Date().toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"})}</div>
          </div>
        </div>

        {/* Content */}
        <div style={{flex:1,overflowY:"auto",padding:"16px 18px"}}>
          {view==="dashboard"&&<Dashboard items={active} todos={todos} onEdit={openEdit} settings={settings} onNav={navTo}/>}
          {view==="prep"    &&<MeetingPrep items={active} onEdit={openEdit} onStartNote={startNoteFromPrep}/>}
          {view==="notes"   &&<Notes section={section} items={active} settings={settings} onSave={saveNote} onEdit={openEdit} initTmpl={prepTmpl} clearTmpl={()=>setPrepTmpl(null)}/>}
          {view==="cards"   &&<Cards items={sectionItems} settings={settings} onEdit={openEdit} onDelete={deleteItem} onCycle={cycleStatus} onArchive={archiveItem} all={active}/>}
          {view==="search"  &&<Search items={items} todos={todos} settings={settings} onEdit={openEdit}/>}
          {view==="history" &&<History items={active} onEdit={openEdit}/>}
          {view==="archive" &&<Archive items={items} onUnarchive={unarchiveItem} onDelete={deleteItem}/>}
          {view==="todo"    &&<Todo items={active} todos={todos} onChange={setTodos}/>}
          {view==="gantt"   &&<Gantt items={sectionItems} settings={settings}/>}
          {view==="calendar"&&<Cal items={sectionItems} settings={settings} onEdit={openEdit}/>}
          {view==="monitor" &&<Monitor settings={settings} onOpenSettings={()=>setShowSettings(true)}/>}
        </div>
      </div>

      {editItem   &&<EditModal item={editItem} onSave={saveEdit} onClose={()=>setEditItem(null)} all={items}/>}
      {showSettings&&<Settings settings={settings} onSave={setSettings} onClose={()=>setShowSettings(false)} items={items} todos={todos}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
